<ui:composition template="/template/template.xhtml" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui">

    <ui:define name="content">
        <h:form id="logsForm">
            <script type="text/javascript">
                //<![CDATA[
                function resizeLogPanel() {
                    var dialogHeight = $('#logsForm\\:logOverlayPanel')[0].clientHeight;
                    var contentHeight = $('#logsForm\\:contentPanel')[0].clientHeight;
                    if (contentHeight > dialogHeight) {
                        contentHeight = dialogHeight - 16;
                        $('#logsForm\\:contentPanel').css({"max-height":contentHeight});
                    }
                }

                function removeLogColWidth() {
                    $('#logsForm\\:logTable table thead th').css('width', '');
                }

                function adjustTableHeight() {
                    var fieldsetHeight = $('#logsForm\\:logFieldset').outerHeight(true);
                    var fieldsetLegendHeight = $('#logsForm\\:logFieldset legend').outerHeight(true);
                    var em = emHeight();

                    var entireTableHeight = fieldsetHeight - fieldsetLegendHeight - 5*em;
                    $('#logsForm\\:logTable').css({"height":entireTableHeight});

                    var tableHeaderHeight = $('#logsForm\\:logTable .ui-datatable-scrollable-header').outerHeight(true);
                    $('#logsForm\\:logTable .ui-datatable-scrollable-body').css({"height":entireTableHeight - tableHeaderHeight});
                }
                // ]]>
            </script>

            <p:fieldset legend="Log" style="padding-bottom: 1em;" id="logFieldset">

                <p:dataTable widgetVar="logTableVar" var="auditRecord" id="logTable" value="#{auditManager.auditRecords}" 
                        styleClass="scroll-table" style="width: inherit; overflow-y: hidden;" scrollable="true" 
                        resizableColumns="true" tableStyle="table-layout: fixed; word-wrap: break-word; width: 100%;" 
                        filteredValue="#{auditManager.filteredAuditRecords}" liveScroll="true" scrollRows="50">
                    <p:ajax event="filter" ignoreAutoUpdate="true"/>

                    <p:column headerText="Timestamp" filterBy="#{auditRecord.logTimeFormatted}" 
                            sortBy="#{auditRecord.logTimeFormatted}" filterMatchMode="contains">
                        <h:outputText value="#{auditRecord.logTimeFormatted}" />                            
                    </p:column>

                    <p:column headerText="User" sortBy="#{auditRecord.user}" filterBy="#{auditRecord.user}" 
                             filterMatchMode="contains">
                        <h:outputText value="#{auditRecord.user}" />
                    </p:column>

                    <p:column headerText="Operation" sortBy="#{auditRecord.oper}" filterBy="#{auditRecord.oper}" 
                            filterMatchMode="exact" filterOptions="#{auditManager.auditOperations}">
                        <h:outputText value="#{auditRecord.oper}" />
                    </p:column>

                    <p:column headerText="Entity Name" sortBy="#{auditRecord.entityKey}" filterBy="#{auditRecord.entityKey}" 
                             filterMatchMode="contains">
                        <h:outputText value="#{auditRecord.entityKey}" />
                    </p:column>

                    <p:column headerText="Entity Type" sortBy="#{auditRecord.entityType}" filterBy="#{auditRecord.entityType}" 
                            filterMatchMode="exact" filterOptions="#{auditManager.entityTypes}">
                        <h:outputText value="#{auditRecord.entityType.label}" />
                    </p:column>

                    <p:column headerText="Entity ID" sortBy="#{auditRecord.entityId}" filterBy="#{auditRecord.entityId}" 
                            filterMatchMode="contains">
                        <h:outputText value="#{auditRecord.entityId}" />
                    </p:column>

                    <p:column headerText="Change" sortBy="#{auditRecord.entry}" filterBy="#{auditRecord.entry}" filterMatchMode="contains">
                        <p:commandLink id="logDetails" update=":logsForm:logDetailsPanel" action="#{auditManager.handleDetails()}" 
                                oncomplete="PF('overlay').show('#{component.clientId}');resizeLogPanel();">
                            <f:setPropertyActionListener target="#{auditManager.displayRecord}" value="#{auditRecord}" />
                            <h:outputText value="#{auditRecord.entry.length() lt 46 ? auditRecord.entry : auditRecord.entry.substring(0,45).concat('...')}" />
                        </p:commandLink>
                    </p:column>
                </p:dataTable>

                <p:commandButton id="exportButton" icon="ui-icon-disk" value="Export" title="Export" 
                    style="float: right; margin-top: 1em;" oncomplete="PF('exportLogs').show();" 
                    disabled="#{empty auditManager.auditRecords}" update=":exportLogsForm:exportLogs" 
                    actionListener="#{auditManager.simpleTableDialog.prepareTableExportPopup}" />
            </p:fieldset>

            <p:overlayPanel id="logOverlayPanel" widgetVar="overlay" dismissable="false" showCloseIcon="true" 
                    style="max-width: 50%; max-height:35%;">
                <p:outputPanel id="logDetailsPanel">
                    <p:panel id="contentPanel" rendered="#{not empty auditManager.formattedDetails}" style="overflow: auto;">
                        <h:outputText value="#{auditManager.formattedDetails}" escape="false" 
                                style="font-family: monospace; white-space:pre;" />
                    </p:panel>
                </p:outputPanel>
            </p:overlayPanel>
        </h:form>
        <ui:include src="/resources/dialogs/export-table.xhtml">
            <ui:param name="formId" value="exportLogsForm" />
            <ui:param name="widgetName" value="exportLogs" />
            <ui:param name="dialogTitle" value="Export Log" />
            <ui:param name="fileFormatSelection" value="#{auditManager.simpleTableDialog.fileFormat}" />
            <ui:param name="includeHeader" value="#{auditManager.simpleTableDialog.includeHeaderRow}" />
            <ui:param name="tableFile" value="#{auditManager.simpleTableDialog.exportedTable}" />
        </ui:include>

        <script type="text/javascript">
            jQuery(document).ready(function() {
                removeLogColWidth();
                adjustFieldsetHeight('#logsForm\\:logFieldset');
                adjustTableHeight();
            });
            jQuery(window).resize(function() {
                adjustFieldsetHeight('#logsForm\\:logFieldset');
                adjustTableHeight();
            });
        </script>
    </ui:define>
</ui:composition>