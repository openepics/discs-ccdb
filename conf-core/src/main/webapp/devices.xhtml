<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    template="/template/template.xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:rc="http://java.sun.com/jsf/composite/comps"
    xmlns:h="http://java.sun.com/jsf/html">

    <ui:define name="content">
        <p:growl showDetail="true" globalOnly="true" autoUpdate="true" />
        <h:form id="devicesForm">
            <script type="text/javascript">
                // <![CDATA[
                function removePropColWidth() {
                    $('#devicesForm\\:devicesTable table thead th').css('width', '');
                    $('#devicesForm\\:attributesDataTable\\:attributesDataTable table thead th').css('width', '');
                }
                function adjustTableHeights() {
                    var fieldsetHeight = $('#devicesForm\\:deviceFieldset').outerHeight(true);
                    var fieldsetLegendHeight = $('#devicesForm\\:deviceFieldset legend').outerHeight(true);
                    var em = emHeight();

                    var entireTableHeight = fieldsetHeight - fieldsetLegendHeight - 5*em;
                    $('#devicesForm\\:devicesTable').css({"height":entireTableHeight});
                    var tableHeaderHeight = $('#devicesForm\\:devicesTable .ui-datatable-scrollable-header').outerHeight(true);
                    $('#devicesForm\\:devicesTable .ui-datatable-scrollable-body').css({"height":entireTableHeight - tableHeaderHeight});
                    
                    
                    $('#devicesForm\\:attributesDataTable\\:attributesDataTable').css({"height":entireTableHeight});
                    tableHeaderHeight = $('#devicesForm\\:attributesDataTable\\:attributesDataTable .ui-datatable-scrollable-header').outerHeight(true);
                    $('#devicesForm\\:attributesDataTable\\:attributesDataTable .ui-datatable-scrollable-body').css({"height":entireTableHeight - tableHeaderHeight});
                }
                // ]]>
            </script>
            <p:panelGrid styleClass="noBorders noPaddingLeft">
                <p:row>
                    <p:column style="width: 50%; vertical-align: top;">
                        <p:fieldset id="deviceFieldset" legend="Devices">
                            <p:dataTable id="devicesTable" var="device" widgetVar="devicesTableVar" 
                                    value="#{deviceDetailsAttributesController.devices}" resizableColumns="true" 
                                    style="width: inherit; overflow-y: hidden;" scrollable="true" scrollRows="50" 
                                    filteredValue="#{deviceDetailsAttributesController.filteredDevices}" styleClass="scroll-table" 
                                    tableStyle="table-layout: fixed; word-wrap: break-word; width: 100%;" 
                                    selection="#{deviceDetailsAttributesController.selectedDevices}" liveScroll="true" 
                                    selectionMode="multiple" rowKey="#{device.device.id}" emptyMessage="No devices found.">
                                <p:ajax event="rowSelect" update=":devicesForm:deleteButton :devicesForm:editButton 
                                                :devicesForm:attributesDataTable:attributesDataTable :devicesForm:deleteAttrButton
                                                :devicesForm:editAttrButton :devicesForm:addButton" 
                                        listener="#{deviceDetailsAttributesController.onRowSelect}" />
                                <p:ajax event="rowUnselect" update=":devicesForm:deleteButton :devicesForm:editButton 
                                                :devicesForm:attributesDataTable:attributesDataTable :devicesForm:deleteAttrButton
                                                :devicesForm:editAttrButton :devicesForm:addButton" 
                                        listener="#{deviceDetailsAttributesController.onRowSelect}" />

                                <p:column headerText="Type" sortBy="#{device.device.componentType.name}" filterStyle="width: 90%;" 
                                        filterBy="#{device.device.componentType.name}" filterMatchMode="contains">
                                    <h:link outcome="deviceTypesManager" value="#{device.device.componentType.name}" class="link">
                                        <f:param name="id" value="#{device.device.componentType.id}" />
                                    </h:link>                                    
                                </p:column>

                                <p:column headerText="Inventory ID" sortBy="#{device.inventoryId}" filterStyle="width: 90%;" 
                                        filterBy="#{device.inventoryId}" filterMatchMode="contains">
                                    <h:outputText value="#{device.inventoryId}" />
                                </p:column>

                                <p:column headerText="Installed in" sortBy="#{device.installedIn}" filterStyle="width: 90%;" 
                                        filterBy="#{device.installedIn}" filterMatchMode="contains">
                                    <h:outputLink rendered="#{!empty device.installedSlotId}" 
                                            value="#{request.contextPath}/?id=#{device.installedSlotId}">
                                        <h:outputText value="#{device.installedIn}" style="text-decoration: underline;" />
                                    </h:outputLink>
                                    <h:outputText value="-" rendered="#{empty device.installedSlotId}" />
                                </p:column>

                                <p:column headerText="Installation timestamp" sortBy="#{device.installationDate}" filterStyle="width: 90%;" 
                                        filterBy="#{device.installationDate}" filterMatchMode="contains">
                                    <h:outputText value="#{device.installationDate}" />
                                </p:column>
                            </p:dataTable>
                            <p:commandButton id="exportButton" icon="ui-icon-disk" value="Export" title="Export" 
                                style="float: right; margin-top: 1em;" oncomplete="PF('exportDevices').show();" 
                                disabled="#{empty deviceDetailsAttributesController.devices}" update=":exportDevForm:exportDevices" 
                                actionListener="#{deviceDetailsAttributesController.simpleTableDialog.prepareTableExportPopup}" />
                            <p:commandButton id="deleteButton" ajax="true" style="float: right; margin: 1em 1ex 0 0;" 
                                value="Delete" icon="ui-icon-trash" title="Delete selected device instances" 
                                actionListener="#{deviceDetailsAttributesController.checkDevicesForDeletion()}"
                                oncomplete="PF('deleteDevices').show();" update=":deleteDevicesForm:deleteDevices" 
                                disabled="#{empty deviceDetailsAttributesController.selectedDevices}" />
                            <p:commandButton id="editButton" ajax="true" style="float: right; margin: 1em 1ex 0 0;" 
                                value="Edit" title="Edit selected device instance" icon="ui-icon-pencil" 
                                action="#{deviceDetailsAttributesController.prepareEditPopup()}" 
                                update=":deviceEditForm" oncomplete="PF('editDeviceDialog').show();" 
                                disabled="#{not deviceDetailsAttributesController.singleDeviceSelected}" />
                            <p:commandButton value="Add" style="float: right; margin: 1em 1ex 0 0;" icon="ui-icon-plus" 
                                actionListener="#{deviceDetailsAttributesController.clearDeviceDialogFields()}" 
                                oncomplete="PF('addDeviceDialog').show();" update=":deviceAddForm:addDeviceDialog" />
                        </p:fieldset>
                    </p:column>            
                    <p:column style="width: 50%; vertical-align: top;">
                        <p:fieldset id="propFieldset" legend="Properties">
                            <rc:new-attribute-table id="attributesDataTable" controllerBean="#{deviceDetailsAttributesController}" 
                                updateTargets=":modifyPropertyValueForm :modifyArtifactForm" 
                                updateButtons=":devicesForm:editAttrButton :devicesForm:deleteAttrButton" />

                            <p:commandButton id="deleteAttrButton" value="Delete" icon="ui-icon-trash" 
                                style="float: right; margin-top: 1em;" oncomplete="PF('deleteAttributes').show();"
                                update=":deleteAttributesForm:deleteAttributes" 
                                actionListener="#{deviceDetailsAttributesController.checkAttributesForDeletion()}"
                                disabled="#{empty deviceDetailsAttributesController.selectedAttributes}" />

                            <p:commandButton id="editAttrButton" value="Edit" icon="ui-icon-pencil" 
                                action="#{deviceDetailsAttributesController.prepareModifyPropertyPopUp()}" 
                                style="float: right; margin: 1em 1ex 0 0;" update=":modifyPropertyValueForm :modifyArtifactForm" 
                                disabled="#{not deviceDetailsAttributesController.singleAttributeSelected or 
                                    not deviceDetailsAttributesController.canEdit(deviceDetailsAttributesController.selectedAttributes.get(0))}" />

                            <p:menuButton id="addButton" value="Add" style="float: right; margin: 1em 1ex 0 0;" 
                                    disabled="#{not deviceDetailsAttributesController.singleDeviceSelected}">
                                <p:menuitem value="Tag" oncomplete="PF('addDeviceTag').show()" update=":addDeviceTagForm:addDeviceTag" 
                                        actionListener="#{deviceDetailsAttributesController.prepareForTagAdd}" />
                                <p:menuitem value="Artifact" oncomplete="PF('addArtifact').show()" 
                                        actionListener="#{deviceDetailsAttributesController.prepareForArtifactAdd}" 
                                        update=":addArtifactForm:addArtifact" />
                            </p:menuButton>
                        </p:fieldset>
    	            </p:column>
                </p:row>
            </p:panelGrid>
        </h:form>

        <script type="text/javascript">
            // <![CDATA[
            jQuery(window).resize(function() {
                adjustFieldsetHeight('#devicesForm\\:deviceFieldset');
                adjustFieldsetHeight('#devicesForm\\:propFieldset');
                adjustTableHeights();
            });
            jQuery(document).ready(function() {
                adjustFieldsetHeight('#devicesForm\\:deviceFieldset');
                adjustFieldsetHeight('#devicesForm\\:propFieldset');
                removePropColWidth();
                adjustTableHeights();
            });
            // ]]>
        </script>

        <ui:include src="/resources/dialogs/device-add-or-modify-dialog.xhtml">
            <ui:param name="formId" value="deviceAddForm" />
            <ui:param name="widgetName" value="addDeviceDialog" />
            <ui:param name="dialogTitle" value="Add device" />
            <ui:param name="updateComponents" value=":devicesForm:devicesTable :devicesForm:deleteButton 
                                                    :devicesForm:editButton :devicesForm:exportButton" />
            <ui:param name="submitHandler" value="onDeviceAdd" />
            <ui:param name="batchCreation" value="true" />
            <ui:param name="saveAction" value="PF('devicesTableVar').clearFilters(); adjustTableHeights();" />
        </ui:include>

        <ui:include src="/resources/dialogs/device-add-or-modify-dialog.xhtml">
            <ui:param name="formId" value="deviceEditForm" />
            <ui:param name="widgetName" value="editDeviceDialog" />
            <ui:param name="dialogTitle" value="Edit device" />
            <ui:param name="saveAction" value="PF('devicesTableVar').clearFilters(); adjustTableHeights();" />
            <ui:param name="updateComponents" value=":devicesForm:devicesTable :devicesForm:deleteButton 
                                                    :devicesForm:editButton :devicesForm:exportButton" />
            <ui:param name="submitHandler" value="onDeviceEdit" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-value.xhtml">
            <ui:param name="formId" value="modifyPropertyValueForm" />
            <ui:param name="dialogTitle" value="Modify device type property" />
            <ui:param name="widgetName" value="modifyPropertyValue" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="controller" value="#{deviceDetailsAttributesController}" />
            <ui:param name="submitHandler" value="modifyPropertyValue" />
            <ui:param name="componentToUpdate" value=":devicesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/tag.xhtml">
            <ui:param name="formId" value="addDeviceTagForm" />
            <ui:param name="dialogTitle" value="Add new device instance tag" />
            <ui:param name="widgetName" value="addDeviceTag" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="controller" value="#{deviceDetailsAttributesController}" />
            <ui:param name="submitHandler" value="addNewTag" />
            <ui:param name="componentToUpdate" value=":devicesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml">
            <ui:param name="formId" value="addArtifactForm" />
            <ui:param name="dialogTitle" value="Add new device instance artifact" />
            <ui:param name="widgetName" value="addArtifact" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="controller" value="#{deviceDetailsAttributesController}" />
            <ui:param name="submitHandler" value="addNewArtifact" />
            <ui:param name="componentToUpdate" value=":devicesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml">
            <ui:param name="formId" value="modifyArtifactForm" />
            <ui:param name="dialogTitle" value="Modify device type artifact" />
            <ui:param name="widgetName" value="modifyArtifact" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="controller" value="#{deviceDetailsAttributesController}" />
            <ui:param name="submitHandler" value="modifyArtifact" />
            <ui:param name="componentToUpdate" value=":devicesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-multi-confirmation.xhtml" >
            <ui:param name="formId" value="deleteDevicesForm" />
            <ui:param name="dialogTitle" value="Delete devices" />
            <ui:param name="widgetName" value="deleteDevices" />
            <ui:param name="controller" value="#{deviceDetailsAttributesController}" />
            <ui:param name="deletePreventionList" value="#{deviceDetailsAttributesController.usedDevices}" />
            <ui:param name="deleteList" value="#{deviceDetailsAttributesController.selectedDevices}" />
            <ui:param name="submitHandler" value="onDeviceDelete" />
            <ui:param name="formsToUpdate" value=":devicesForm:attributesDataTable:attributesDataTable 
                                                    :devicesForm:editAttrButton :devicesForm:deleteAttrButton" />
            <ui:param name="closeDialogActions" value="PF('devicesTableVar').clearFilters(); PF('devicesTableVar').clearFilters(); adjustTableHeights();" />
            <ui:param name="entityType" value="device instances" />
            <ui:param name="entityName" value="Device instance" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-multi-confirmation.xhtml" >
            <ui:param name="formId" value="deleteAttributesForm" />
            <ui:param name="dialogTitle" value="Delete attributes" />
            <ui:param name="widgetName" value="deleteAttributes" />
            <ui:param name="controller" value="#{deviceDetailsAttributesController}" />
            <ui:param name="deletePreventionList" value="#{deviceDetailsAttributesController.nonDeletableAttributes}" />
            <ui:param name="deleteList" value="#{deviceDetailsAttributesController.selectedAttributes}" />
            <ui:param name="submitHandler" value="deleteAttributes" />
            <ui:param name="formsToUpdate" value=":devicesForm:attributesDataTable:attributesDataTable 
                                                    :devicesForm:editAttrButton :devicesForm:deleteAttrButton" />
            <ui:param name="closeDialogActions" value="PF('attributesDataTable').clearFilters; adjustTableHeights();" />
            <ui:param name="entityType" value="attributes" />
            <ui:param name="entityName" value="Attribute" />
        </ui:include>

        <ui:include src="/resources/dialogs/batch-creation-conflict.xhtml">
            <ui:param name="formId" value="batchConflictForm" />
            <ui:param name="dialogTitle" value="Conflicting device instances" />
            <ui:param name="widgetName" value="batchConflict" />
            <ui:param name="entity" value="device instances" />
            <ui:param name="entityListing" value="#{deviceDetailsAttributesController.batchSerialConflicts}" />
            <ui:param name="relatedDialog" value="addDeviceDialog" />
            <ui:param name="controller" value="#{deviceDetailsAttributesController}" />
            <ui:param name="submitHandler" value="creationProceed" />
            <ui:param name="formToUpdate" value=":devicesForm:devicesTable :devicesForm:deleteButton :devicesForm:editButton" />
            <ui:param name="saveActions" value="adjustTableHeights();" />
        </ui:include>

        <ui:include src="/resources/dialogs/export-table.xhtml">
            <ui:param name="formId" value="exportDevForm" />
            <ui:param name="widgetName" value="exportDevices" />
            <ui:param name="dialogTitle" value="Export device instances table" />
            <ui:param name="fileFormatSelection" value="#{deviceDetailsAttributesController.simpleTableDialog.fileFormat}" />
            <ui:param name="includeHeader" value="#{deviceDetailsAttributesController.simpleTableDialog.includeHeaderRow}" />
            <ui:param name="tableFile" value="#{deviceDetailsAttributesController.simpleTableDialog.exportedTable}" />
        </ui:include>
    </ui:define>
</ui:composition>
