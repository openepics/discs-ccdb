<ui:composition template="/template/template.xhtml" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:rc="http://java.sun.com/jsf/composite/comps"
    xmlns:p="http://primefaces.org/ui">

    <ui:define name="content">
        <h:form id="containersForm">
            <script type="text/javascript">
                function disableAddButton() {
                   $('#containersForm\\:addButton').prop('disabled',true).addClass('ui-state-disabled');
                }
                function enableAddButton() {
                    $('#containersForm\\:addButton').prop('disabled',false).removeClass('ui-state-disabled');
                }
            </script>

            <p:panelGrid styleClass="noBorders">
                <p:row>
                    <p:column style="width: 40%; min-width: 20em;">
                        <p:fieldset legend="Containers" id="containersFieldset">
                            <p:treeTable id="containersTree" value="#{containerController.rootNode}" var="container" liveResize="true" 
                                    selection="#{containerController.selectedNode}" selectionMode="single" scrollable="true" 
                                    scrollWidth="auto">
                                <p:ajax event="collapse" listener="#{containerController.onNodeCollapse}" />
                                <p:ajax event="expand" listener="#{containerController.onNodeExpand}" />
                                <p:ajax event="select" oncomplete="enableAddButton();" 
                                    listener="#{slotAttributesController.prepareSelectedSlot(containerController.selectedNode)}" 
                                    update=":containersForm:editButton :containersForm:upButton :containersForm:downButton 
                                                :containersForm:deleteButton :containersForm:attributesDataTable:attributesDataTable
                                                :containersForm:editAttrButton :containersForm:deleteAttrButton" />
                                <p:ajax event="unselect" oncomplete="disableAddButton();" 
                                    listener="#{slotAttributesController.clearSelectedSlot()}" 
                                    update=":containersForm:editButton :containersForm:upButton :containersForm:downButton 
                                                :containersForm:deleteButton :containersForm:attributesDataTable:attributesDataTable
                                                :containersForm:editAttrButton :containersForm:deleteAttrButton" />

                                <p:column id="name" headerText="Name">
                                    <h:outputText value="#{container.name}" />
                                </p:column>

                                <p:column id="desc" headerText="Description">
                                    <h:outputText value="#{container.description}" />
                                </p:column>
                            </p:treeTable>

                            <p:commandButton id="deleteButton" icon="ui-icon-trash" value="Delete" title="Delete" 
                                style="float: right;  margin-top: 1em;" oncomplete="PF('deleteContainer').show();" 
                                disabled="#{empty containerController.selectedNode || !containerController.selectedNode.data.canDelete}" 
                                actionListener="#{containerController.prepareDeletePopup()}" />
                            <p:commandButton id="downButton" icon="ui-icon-arrowthick-1-s" value="Down" title="Move down" 
                                style="float: right; margin: 1em 1ex 0 0;" oncomplete="resizeContainerPanel();"
                                update=":containersForm:containersTree :containersForm:downButton :containersForm:upButton" 
                                disabled="#{empty containerController.selectedNode || containerController.selectedNode.data.last}" 
                                actionListener="#{containerController.moveSlotDown()}" />
                            <p:commandButton id="upButton" icon="ui-icon-arrowthick-1-n" value="Up" title="Move up" 
                                style="float: right; margin: 1em 1ex 0 0;" oncomplete="resizeContainerPanel();"
                                update=":containersForm:containersTree :containersForm:upButton :containersForm:downButton" 
                                disabled="#{empty containerController.selectedNode || containerController.selectedNode.data.first}" 
                                actionListener="#{containerController.moveSlotUp()}" />
                            <p:commandButton id="editButton" icon="ui-icon-pencil" value="Edit" title="Edit" 
                                style="float: right; margin: 1em 1ex 0 0;" update=":modifyContainerForm:modifyContainer" 
                                disabled="#{empty containerController.selectedNode}" oncomplete="PF('modifyContainer').show();" 
                                actionListener="#{containerController.prepareEditPopup()}" />
                            <p:commandButton id="addSlot" actionListener="#{containerController.prepareAddPopup()}" 
                                value="Add" oncomplete="PF('addContainer').show();" icon="ui-icon-plus" 
                                title="Add new container to parent" style="float: right; margin: 1em 1ex 0 0;"
                                update=":addContainerForm:addContainer" />
                        </p:fieldset>
                    </p:column>
                    <p:column style="width: 60%; min-width: 30em;">
                        <p:fieldset legend="Properties" id="propFieldset">
                            <rc:new-attribute-table id="attributesDataTable" controllerBean="#{slotAttributesController}" 
                                updateTargets=":modifyPropertyValueForm :modifyArtifactForm" 
                                updateButtons=":containersForm:editAttrButton :containersForm:deleteAttrButton" />

                        <p:commandButton id="deleteAttrButton" value="Delete" icon="ui-icon-trash" 
                            style="float: right;" oncomplete="PF('deleteAttribute').show();" 
                            disabled="#{empty slotAttributesController.selectedAttribute ? true : not slotAttributesController.canDelete(slotAttributesController.selectedAttribute)}" />

                        <p:commandButton id="editAttrButton" value="Edit" icon="ui-icon-pencil" 
                            action="#{slotAttributesController.prepareModifyPropertyPopUp()}" 
                            style="float: right; margin-right: 1ex;" update=":modifyPropertyValueForm :modifyArtifactForm" 
                            disabled="#{empty slotAttributesController.selectedAttribute ? true : not slotAttributesController.canEdit(slotAttributesController.selectedAttribute)}" />

                        <p:commandButton id="addButton" value="Add" type="button" icon="ui-icon-plus" disabled="true" 
                            style="margin-right: 1ex; float: right;" />
                        <p:menu overlay="true" trigger="addButton" my="left bottom" at="left top">
                            <p:menuitem value="Property" oncomplete="PF('addPropertyValue').show();" 
                                    actionListener="#{slotAttributesController.prepareForPropertyValueAdd}" 
                                    update=":addPropertyValueForm:addPropertyValue" />
                            <p:menuitem value="Tag" oncomplete="PF('containerTag').show();" update=":containerTagForm" 
                                    actionListener="#{slotAttributesController.prepareForTagAdd}" />
                            <p:menuitem value="Artifact" oncomplete="PF('addArtifact').show();" 
                                    actionListener="#{slotAttributesController.prepareForArtifactAdd}" 
                                    update=":addArtifactForm:addArtifact" />
                        </p:menu>

                        </p:fieldset>
                    </p:column>
                </p:row>
            </p:panelGrid>
        </h:form>

        <ui:include src="add-or-modify-container.xhtml" >
            <ui:param name="formId" value="addContainerForm" />
            <ui:param name="dialogTitle" value="Add new container" />
            <ui:param name="widgetName" value="addContainer" />
            <ui:param name="submitHandler" value="onSlotAdd" />
        </ui:include>

        <ui:include src="add-or-modify-container.xhtml" >
            <ui:param name="formId" value="modifyContainerForm" />
            <ui:param name="dialogTitle" value="Modify a container" />
            <ui:param name="widgetName" value="modifyContainer" />
            <ui:param name="submitHandler" value="onSlotModify" />
        </ui:include>

        <ui:include src="../add-or-modify-dialogs/delete-confirmation.xhtml" >
            <ui:param name="formId" value="deleteContainerForm" />
            <ui:param name="dialogTitle" value="Delete container" />
            <ui:param name="widgetName" value="deleteContainer" />
            <ui:param name="controller" value="#{containerController}" />
            <ui:param name="submitHandler" value="onDelete" />
            <ui:param name="formToUpdate" value=":containersForm:containersTree :containersForm:deleteButton" />
            <ui:param name="resizeContent" value="resizeContainerPanel();" />
            <ui:param name="entityType" value="this container" />
        </ui:include>

        <ui:include src="../add-or-modify-dialogs/delete-confirmation.xhtml" >
            <ui:param name="formId" value="deleteAttributeForm" />
            <ui:param name="dialogTitle" value="Delete attribute" />
            <ui:param name="widgetName" value="deleteAttribute" />
            <ui:param name="controller" value="#{slotAttributesController}" />
            <ui:param name="submitHandler" value="deleteAttribute" />
            <ui:param name="formToUpdate" value=":containersForm:attributesDataTable:attributesDataTable :containersForm:editAttrButton :containersForm:deleteAttrButton" />
            <ui:param name="entityType" value="selected attribute" />
        </ui:include>

        <ui:include src="../add-or-modify-dialogs/property-value.xhtml" >
            <ui:param name="formId" value="addPropertyValueForm" />
            <ui:param name="dialogTitle" value="Add new container property" />
            <ui:param name="widgetName" value="addPropertyValue" />
            <ui:param name="controller" value="#{slotAttributesController}" />
            <ui:param name="submitHandler" value="addNewPropertyValue" />
            <ui:param name="componentToUpdate" value=":containersForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="../add-or-modify-dialogs/property-value.xhtml" >
            <ui:param name="formId" value="modifyPropertyValueForm" />
            <ui:param name="dialogTitle" value="Modify container property" />
            <ui:param name="widgetName" value="modifyPropertyValue" />
            <ui:param name="controller" value="#{slotAttributesController}" />
            <ui:param name="submitHandler" value="modifyPropertyValue" />
            <ui:param name="componentToUpdate" value=":containersForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="../add-or-modify-dialogs/tag.xhtml" >
            <ui:param name="formId" value="containerTagForm" />
            <ui:param name="dialogTitle" value="Add new container tag" />
            <ui:param name="widgetName" value="containerTag" />
            <ui:param name="controller" value="#{slotAttributesController}" />
            <ui:param name="submitHandler" value="addNewTag" />
            <ui:param name="componentToUpdate" value=":containersForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="../add-or-modify-dialogs/artifact.xhtml" >
            <ui:param name="formId" value="addArtifactForm" />
            <ui:param name="dialogTitle" value="Add new container artifact" />
            <ui:param name="widgetName" value="addArtifact" />
            <ui:param name="controller" value="#{slotAttributesController}" />
            <ui:param name="submitHandler" value="addNewArtifact" />
            <ui:param name="componentToUpdate" value=":containersForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="../add-or-modify-dialogs/artifact.xhtml" >
            <ui:param name="formId" value="modifyArtifactForm" />
            <ui:param name="dialogTitle" value="Modify container artifact" />
            <ui:param name="widgetName" value="modifyArtifact" />
            <ui:param name="controller" value="#{slotAttributesController}" />
            <ui:param name="submitHandler" value="modifyArtifact" />
            <ui:param name="componentToUpdate" value=":containersForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <script type="text/javascript">
            jQuery(window).resize(function() {
                resizeContainerPanel();
                adjustFieldsetHeight('#containersForm\\:containersFieldset');
                adjustFieldsetHeight('#containersForm\\:propFieldset');
            });

            jQuery(document).ready(function() {
                resizeContainerPanel();
                adjustFieldsetHeight('#containersForm\\:containersFieldset');
                adjustFieldsetHeight('#containersForm\\:propFieldset');
            });
        </script>
    </ui:define>
</ui:composition>