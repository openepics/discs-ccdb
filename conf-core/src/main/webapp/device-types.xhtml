<ui:composition template="/template/template.xhtml"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:rc="http://java.sun.com/jsf/composite/comps"
    xmlns:p="http://primefaces.org/ui">
    <ui:define name="content">
        <h:form id="deviceTypesForm">
            <script type="text/javascript">
                // <![CDATA[
                function adjustTableHeights() {                	                    
                    var fieldsetHeight = $('#deviceTypesForm\\:devTypeFieldset').outerHeight(true);
                    var fieldsetLegendHeight = $('#deviceTypesForm\\:devTypeFieldset legend').outerHeight(true);
                    var em = emHeight();

                    var entireTableHeight = fieldsetHeight - fieldsetLegendHeight - 5*em;
                    $('#deviceTypesForm\\:deviceTypeTable').css({"height":entireTableHeight});
                    var tableHeaderHeight = $('#deviceTypesForm\\:deviceTypeTable .ui-datatable-scrollable-header').outerHeight(true);
                    $('#deviceTypesForm\\:deviceTypeTable .ui-datatable-scrollable-body').css({"height":entireTableHeight - tableHeaderHeight});

                    $('#deviceTypesForm\\:attributesDataTable\\:attributesDataTable').css({"height":entireTableHeight});
                    tableHeaderHeight = $('#deviceTypesForm\\:attributesDataTable\\:attributesDataTable .ui-datatable-scrollable-header').outerHeight(true);
                    $('#deviceTypesForm\\:attributesDataTable\\:attributesDataTable .ui-datatable-scrollable-body').css({"height":entireTableHeight - tableHeaderHeight});
                }
                function removePropColWidth() {
                    $('#deviceTypesForm\\:deviceTypeTable table thead th').css('width', '');
                    $('#deviceTypesForm\\:attributesDataTable\\:attributesDataTable table thead th').css('width', '');
                }
                // ]]>
            </script>
            <p:panelGrid styleClass="noBorders">
                <p:row>
                    <p:column style="width: 35%; min-width: 20em;">
                        <p:fieldset legend="Device type" id="devTypeFieldset">
                            <p:dataTable id="deviceTypeTable" widgetVar="deviceTypeTableVar" var="deviceType"
                                    value="#{componentTypeManager.deviceTypes}" resizableColumns="true"
                                    style="width: inherit; overflow-y: hidden;" scrollable="true"
                                    filteredValue="#{componentTypeManager.filteredDeviceTypes}" styleClass="scroll-table"
                                    tableStyle="table-layout: fixed; word-wrap: break-word; width: 100%;"
                                    selection="#{componentTypeManager.selectedDeviceTypes}" liveScroll="true"
                                    selectionMode="multiple" rowKey="#{deviceType.id}" scrollRows="50">
                                <p:ajax event="filter" ignoreAutoUpdate="true" />
                                <p:ajax event="rowSelect" oncomplete="PF('attributesDataTable').filter(); adjustTableHeights();"
                                    listener="#{componentTypeManager.onRowSelect}"
                                    update=":deviceTypesForm:deleteButton :deviceTypesForm:editButton :deviceTypesForm:addButton
                                        :deviceTypesForm:attributesDataTable:attributesDataTable :deviceTypesForm:editAttrButton
                                        :deviceTypesForm:deleteAttrButton :deviceTypesForm:duplicateButton" />
                                <p:ajax event="rowUnselect" oncomplete="PF('attributesDataTable').filter(); adjustTableHeights();"
                                    listener="#{componentTypeManager.onRowSelect}"
                                    update=":deviceTypesForm:deleteButton :deviceTypesForm:editButton :deviceTypesForm:addButton
                                        :deviceTypesForm:attributesDataTable:attributesDataTable :deviceTypesForm:editAttrButton
                                        :deviceTypesForm:deleteAttrButton :deviceTypesForm:duplicateButton" />

                                <p:column headerText="Name" sortBy="#{deviceType.name.toUpperCase()}" filterBy="#{deviceType.name}"
                                        filterMatchMode="contains" style="width: 14em;">
                                    <h:outputText value="#{deviceType.name}" />
                                </p:column>

                                <p:column headerText="Description" sortBy="#{deviceType.description}" filterBy="#{deviceType.description}"
                                        filterMatchMode="contains" style="width: 25em;">
                                    <h:outputText value="#{deviceType.description}" />
                                </p:column>
                            </p:dataTable>

                            <p:commandButton id="duplicateButton" icon="ui-icon-copy" value="Duplicate" title="Duplicate selected"
                                style="float: right; margin-top: 1em;" disabled="#{empty componentTypeManager.selectedDeviceTypes}"
                                oncomplete="adjustTableHeights();PF('deviceTypeTableVar').clearFilters();" update=":deviceTypesForm:deviceTypeTable"
                                actionListener="#{componentTypeManager.duplicate}" />
                            <p:commandButton id="exportButton" icon="ui-icon-disk" value="Export" title="Export"
                                style="float: right; margin-top: 1em;" oncomplete="PF('exportDevTypes').show();"
                                disabled="#{empty componentTypeManager.deviceTypes}" update=":exportDevTypesForm:exportDevTypes"
                                actionListener="#{componentTypeManager.simpleTableDialog.prepareTableExportPopup}" />
                            <p:commandButton id="deleteButton" icon="ui-icon-trash" value="Delete" title="Delete"
                                style="float: right; margin: 1em 1ex 0 0;" oncomplete="PF('deleteDeviceTypes').show();"
                                disabled="#{empty componentTypeManager.selectedDeviceTypes}" update=":deleteDeviceTypesForm:deleteDeviceTypes"
                                actionListener="#{componentTypeManager.checkDeviceTypesForDeletion()}" />
                            <p:commandButton id="editButton" ajax="true" style="float: right; margin: 1em 1ex 0 0;"
                                value="Edit" action="#{componentTypeManager.prepareEditPopup()}"
                                update=":editDeviceTypeForm" icon="ui-icon-pencil" oncomplete="PF('editDeviceType').show();"
                                disabled="#{not componentTypeManager.singleDeviceTypeSelected}" />
                            <p:commandButton ajax="true" style="float: right; margin: 1em 1ex 0 0;" icon="ui-icon-plus"
                                actionListener="#{componentTypeManager.prepareAddPopup()}" value="Add"
                                oncomplete="PF('addDeviceType').show();" />
                        </p:fieldset>
                    </p:column>
                    <p:column style="width: 65%; min-width: 30em;">
                        <p:fieldset legend="Properties" id="propFieldset">
                            <rc:new-attribute-table id="attributesDataTable" controllerBean="#{componentTypeManager}"
                                updateTargets=":modifyPropertyValueForm :modifyArtifactForm"
                                updateButtons=":deviceTypesForm:editAttrButton :deviceTypesForm:deleteAttrButton"
                                parentName="Device Type" />

                            <p:commandButton id="deleteAttrButton" value="Delete" icon="ui-icon-trash"
                                style="float: right; margin-top: 1em;" oncomplete="PF('deleteAttributes').show()"
                                update=":deleteAttributesForm:deleteAttributes"
                                actionListener="#{componentTypeManager.checkAttributesForDeletion()}"
                                disabled="#{empty componentTypeManager.selectedAttributes}" />

                            <p:commandButton id="editAttrButton" value="Edit" icon="ui-icon-pencil"
                                action="#{componentTypeManager.prepareModifyPropertyPopUp()}"
                                style="float: right; margin: 1em 1ex 0 0;" update=":modifyPropertyValueForm :modifyArtifactForm"
                                disabled="#{not componentTypeManager.singleAttributeSelected or
                                    not componentTypeManager.canEdit(componentTypeManager.selectedAttributes.get(0))}" />

                            <p:menuButton id="addButton" value="Add" style="float: right; margin: 1em 1ex 0 0;"
                                disabled="#{not componentTypeManager.singleDeviceTypeSelected}">
                                <p:menuitem value="Device Type Property" oncomplete="PF('addPropertyValue').show();"
                                    actionListener="#{componentTypeManager.prepareForPropertyValueAdd}"
                                    update=":addPropertyValueForm:addPropertyValue" />
                                <p:menuitem value="Installation Slot Property" oncomplete="PF('installationSlotProperty').show();"
                                    actionListener="#{componentTypeManager.prepareForSlotPropertyAdd()}"
                                    update=":installationSlotPropertyForm:installationSlotProperty" />
                                <p:menuitem value="Device Property" oncomplete="PF('deviceInstanceProperty').show();"
                                    actionListener="#{componentTypeManager.prepareForDevicePropertyAdd()}"
                                    update=":deviceInstancePropertyForm:deviceInstanceProperty" />
                                <p:menuitem value="Tag" oncomplete="PF('deviceTypeTag').show();" update=":deviceTypeTagForm"
                                    actionListener="#{componentTypeManager.prepareForTagAdd}" />
                                <p:menuitem value="Artifact" oncomplete="PF('addArtifact').show();"
                                    actionListener="#{componentTypeManager.prepareForArtifactAdd}"
                                    update=":addArtifactForm:addArtifact" />
                            </p:menuButton>
                        </p:fieldset>
                    </p:column>
                </p:row>
            </p:panelGrid>
        </h:form>

        <script type="text/javascript">
            // <![CDATA[
            jQuery(window).resize(function() {
                adjustFieldsetHeight('#deviceTypesForm\\:devTypeFieldset');
                adjustFieldsetHeight('#deviceTypesForm\\:propFieldset');
                adjustTableHeights();
            });

            jQuery(document).ready(function() {
                adjustFieldsetHeight('#deviceTypesForm\\:devTypeFieldset');
                adjustFieldsetHeight('#deviceTypesForm\\:propFieldset');
                removePropColWidth();
                adjustTableHeights();
            });
            // prevent focus of the first element, select the first button (Cancel) instead
            // http://forum.primefaces.org/viewtopic.php?f=3&t=29050
            PrimeFaces.widget.Dialog.prototype.applyFocus = function() {
                if (this.id == "addPropertyValueForm:addPropertyValue"
                        || this.id == "installationSlotPropertyForm:installationSlotProperty"
                        || this.id == "deviceInstancePropertyForm:deviceInstanceProperty") {
                    this.jq.find(':button:input:visible:enabled:first').focus();
                } else {
                    this.jq.find(':not(:submit):not(:button):input:visible:enabled:first').focus();
                }
            }
            // ]]>
        </script>

        <ui:include src="/resources/dialogs/delete-multi-confirmation.xhtml" >
            <ui:param name="formId" value="deleteDeviceTypesForm" />
            <ui:param name="dialogTitle" value="Delete device types" />
            <ui:param name="widgetName" value="deleteDeviceTypes" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="deletePreventionList" value="#{componentTypeManager.usedDeviceTypes}" />
            <ui:param name="deleteList" value="#{componentTypeManager.selectedDeviceTypes}" />
            <ui:param name="filteredDialogList" value="#{componentTypeManager.filteredDialogTypes}" />
            <ui:param name="submitHandler" value="onDelete" />
            <ui:param name="formsToUpdate" value=":deviceTypesForm:deviceTypeTable :deviceTypesForm:deleteButton
                                                :deviceTypesForm:editButton :deviceTypesForm:exportButton
                                                :deviceTypesForm:attributesDataTable:attributesDataTable
                                                :deviceTypesForm:editAttrButton :deviceTypesForm:deleteAttrButton
                                                :deviceTypesForm:duplicateButton" />
            <ui:param name="closeDialogActions"
                value="PF('deviceTypeTableVar').clearFilters(); PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="entityType" value="device types" />
            <ui:param name="entityName" value="Device type" />
        </ui:include>

        <ui:include src="/resources/dialogs/device-type.xhtml">
            <ui:param name="formId" value="addDeviceTypeForm" />
            <ui:param name="dialogTitle" value="Add Device Type" />
            <ui:param name="widgetName" value="addDeviceType" />
            <ui:param name="submitHandler" value="onAdd" />
        </ui:include>

        <ui:include src="/resources/dialogs/device-type.xhtml">
            <ui:param name="formId" value="editDeviceTypeForm" />
            <ui:param name="dialogTitle" value="Edit Device Type" />
            <ui:param name="widgetName" value="editDeviceType" />
            <ui:param name="submitHandler" value="onChange" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-value.xhtml" >
            <ui:param name="formId" value="modifyPropertyValueForm" />
            <ui:param name="dialogTitle" value="Modify device type property" />
            <ui:param name="widgetName" value="modifyPropertyValue" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="submitHandler" value="modifyPropertyValue" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml" >
            <ui:param name="formId" value="modifyArtifactForm" />
            <ui:param name="dialogTitle" value="Modify device type artifact" />
            <ui:param name="widgetName" value="modifyArtifact" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="submitHandler" value="modifyArtifact" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/multi-property-value.xhtml" >
            <ui:param name="formId" value="addPropertyValueForm" />
            <ui:param name="dialogTitle" value="Add new device type property" />
            <ui:param name="widgetName" value="addPropertyValue" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="submitHandler" value="saveMultiplePropertyValues" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-definition.xhtml" >
            <ui:param name="formId" value="installationSlotPropertyForm" />
            <ui:param name="dialogTitle" value="Add new installation slot property" />
            <ui:param name="widgetName" value="installationSlotProperty" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="submitHandler" value="addNewPropertyValueDefs" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-definition.xhtml" >
            <ui:param name="formId" value="deviceInstancePropertyForm" />
            <ui:param name="dialogTitle" value="Add Properties" />
            <ui:param name="widgetName" value="deviceInstanceProperty" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="submitHandler" value="addNewPropertyValueDefs" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/tag.xhtml" >
            <ui:param name="formId" value="deviceTypeTagForm" />
            <ui:param name="dialogTitle" value="Add new device type tag" />
            <ui:param name="widgetName" value="deviceTypeTag" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="submitHandler" value="addNewTag" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:deviceTypeTable :deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml" >
            <ui:param name="formId" value="addArtifactForm" />
            <ui:param name="dialogTitle" value="Add new device type artifact" />
            <ui:param name="widgetName" value="addArtifact" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="submitHandler" value="addNewArtifact" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-multi-confirmation.xhtml" >
            <ui:param name="formId" value="deleteAttributesForm" />
            <ui:param name="dialogTitle" value="Delete Properties" />
            <ui:param name="widgetName" value="deleteAttributes" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="deletePreventionList" value="#{componentTypeManager.nonDeletableAttributes}" />
            <ui:param name="deleteList" value="#{componentTypeManager.selectedAttributes}" />
            <ui:param name="filteredDialogList" value="#{componentTypeManager.filteredDialogAttributes}" />
            <ui:param name="submitHandler" value="deleteAttributes" />
            <ui:param name="formsToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable
                                                :deviceTypesForm:editAttrButton :deviceTypesForm:deleteAttrButton" />
            <ui:param name="closeDialogActions" value="PF('attributesDataTable').clearFilters(); adjustTableHeights();" />
            <ui:param name="entityType" value="attributes" />
            <ui:param name="entityName" value="Attribute" />
        </ui:include>

        <ui:include src="/resources/dialogs/export-table.xhtml">
            <ui:param name="formId" value="exportDevTypesForm" />
            <ui:param name="widgetName" value="exportDevTypes" />
            <ui:param name="dialogTitle" value="Export Device Types" />
            <ui:param name="fileFormatSelection" value="#{componentTypeManager.simpleTableDialog.fileFormat}" />
            <ui:param name="includeHeader" value="#{componentTypeManager.simpleTableDialog.includeHeaderRow}" />
            <ui:param name="tableFile" value="#{componentTypeManager.simpleTableDialog.exportedTable}" />
        </ui:include>
    </ui:define>
</ui:composition>
