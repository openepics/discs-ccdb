<ui:composition template="/template/template.xhtml" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:rc="http://java.sun.com/jsf/composite/comps"
    xmlns:p="http://primefaces.org/ui">
    <ui:define name="content">
        <h:form id="deviceTypesForm">
            <script type="text/javascript">
                // <![CDATA[
                function disableAddButton() {
                   $('#deviceTypesForm\\:addButton').prop('disabled',true).addClass('ui-state-disabled');
                }
                function enableAddButton() {
                    $('#deviceTypesForm\\:addButton').prop('disabled',false).removeClass('ui-state-disabled');
                }
                function adjustTableHights() {
                    var menusHeight = $('#top').outerHeight(true);
                    var fieldsetLegendHeight = $('#deviceTypesForm\\:devTypeFieldset legend').outerHeight(true);
                    var em = emHeight();
                    
                    var totalOtherHeight = menusHeight + fieldsetLegendHeight + 2*em + 7*em;
                    var tableHeight = window.innerHeight - totalOtherHeight;
                    $('#deviceTypesForm\\:deviceTypeTable').css({"height":tableHeight});
                    $('#deviceTypesForm\\:attributesDataTable\\:attributesDataTable').css({"height":tableHeight});
                }
                function selectDeviceTypeInTable(globalIndex) {
                    // selectDeviceTypeInTable() only works on page load, so it can be used for navigating to 
                    //     a device type form another screen. 
                    var devicesTable = PF('deviceTypeTableVar');
                    if (devicesTable.getPaginator().cfg.rowCount < 1) return;
                    
                    var rowsPerPage = devicesTable.getPaginator().cfg.rows;
                    var pageNumber = Math.trunc(globalIndex / rowsPerPage);
                    ccdb_tableSelectedIndex = globalIndex % rowsPerPage;
                    if (pageNumber >= 0) {
                        devicesTable.unselectAllRows();
                        if (pageNumber == devicesTable.getPaginator().getCurrentPage()) {
                            devicesTable.selectRow(ccdb_tableSelectedIndex);
                            ccdb_tableSelectedIndex = -1;
                        } else {
                            // after page change 'onTablePageSwitchAction()' will be called by the framework
                            devicesTable.getPaginator().setPage(pageNumber);
                        }
                    }
                }
                var ccdb_tableSelectedIndex = -1;
                function onTablePageSwitchAction() {
                    if (ccdb_tableSelectedIndex > -1) {
                        PF('deviceTypeTableVar').selectRow(ccdb_tableSelectedIndex);
                        ccdb_tableSelectedIndex = -1;
                    }
                }
                // ]]>
            </script>
            <p:remoteCommand name="clearDeviceType" actionListener="#{componentTypeManager.clearSelectedDeviceType()}" 
                update=":deviceTypesForm:deviceTypeTable :deviceTypesForm:deleteButton :deviceTypesForm:editButton" 
                oncomplete="clearDeviceTypeAttributes();" />
            <p:remoteCommand name="clearDeviceTypeAttributes" actionListener="#{comptypeAttributesController.clearDeviceType()}" 
                update=":deviceTypesForm:attributesDataTable:attributesDataTable :deviceTypesForm:editAttrButton :deviceTypesForm:deleteAttrButton" 
                oncomplete="disableAddButton();" />
            <p:panelGrid styleClass="noBorders">
                <p:row>
                    <p:column style="width: 35%; min-width: 20em;">
                        <p:fieldset legend="Device type" id="devTypeFieldset">
                            <p:dataTable id="deviceTypeTable" widgetVar="deviceTypeTableVar" var="deviceType" 
                                    value="#{componentTypeManager.deviceTypes}" resizableColumns="true" 
                                    style="table-layout: fixed; word-wrap: break-word; margin: 1em 0 1em 0;" 
                                    filteredValue="#{componentTypeManager.filteredDeviceTypes}" rows="15" paginator="true" 
                                    paginatorPosition="bottom" selection="#{componentTypeManager.selectedDeviceType}" 
                                    selectionMode="single" rowKey="#{deviceType.id}">
                                <p:ajax event="filter" ignoreAutoUpdate="true" />
                                <p:ajax event="rowSelect" oncomplete="enableAddButton();adjustTableHights();"
                                    listener="#{comptypeAttributesController.prepareDeviceType(componentTypeManager.selectedDeviceType)}" 
                                    update=":deviceTypesForm:deleteButton :deviceTypesForm:editButton  
                                        :deviceTypesForm:attributesDataTable:attributesDataTable :deviceTypesForm:editAttrButton 
                                        :deviceTypesForm:deleteAttrButton" />
                                <p:ajax event="rowUnselect" oncomplete="disableAddButton();"
                                    listener="#{comptypeAttributesController.clearDeviceType()}" 
                                    update=":deviceTypesForm:deleteButton :deviceTypesForm:editButton 
                                        :deviceTypesForm:attributesDataTable:attributesDataTable :deviceTypesForm:editAttrButton 
                                        :deviceTypesForm:deleteAttrButton" />
                                <p:ajax event="page" oncomplete="onTablePageSwitchAction();" />
    
                                <p:column headerText="Name" sortBy="#{deviceType.name.toUpperCase()}" filterBy="#{deviceType.name}" 
                                        filterMatchMode="contains" style="width: 14em;" filterStyle="width: 90%;">
                                    <h:outputText value="#{deviceType.name}" />
                                </p:column>
    
                                <p:column headerText="Description" sortBy="#{deviceType.description}" filterBy="#{deviceType.description}" 
                                        filterMatchMode="contains" style="width: 25em;" filterStyle="width: 75%;">
                                    <h:outputText value="#{deviceType.description}" />
                                </p:column>
                            </p:dataTable>
                            <p:commandButton id="deleteButton" ajax="true" style="float: right;" value="Delete" 
                                icon="ui-icon-trash" oncomplete="PF('deleteDeviceType').show();" 
                                disabled="#{empty componentTypeManager.selectedDeviceType}" />
                            <p:commandButton id="editButton" ajax="true" style="float: right; margin-right: 1ex;" 
                                value="Edit" action="#{componentTypeManager.prepareEditPopup()}" 
                                update=":editDeviceTypeForm" icon="ui-icon-pencil" oncomplete="PF('editDeviceType').show();" 
                                disabled="#{empty componentTypeManager.selectedDeviceType}" />
                            <p:commandButton ajax="true" style="float: right; margin-right: 1ex;" icon="ui-icon-plus" 
                                actionListener="#{componentTypeManager.prepareAddPopup()}" value="Add" 
                                oncomplete="PF('addDeviceType').show();" />
                        </p:fieldset>
                    </p:column>
                    <p:column style="width: 65%; min-width: 30em;">
                        <p:fieldset legend="Properties" id="propFieldset">
                            <rc:new-attribute-table id="attributesDataTable" controllerBean="#{comptypeAttributesController}" 
                                updateTargets=":modifyPropertyValueForm :modifyArtifactForm" 
                                updateButtons=":deviceTypesForm:editAttrButton :deviceTypesForm:deleteAttrButton" />
    
                            <p:commandButton id="deleteAttrButton" value="Delete" icon="ui-icon-trash" 
                                style="float: right;" oncomplete="PF('deleteAttribute').show()"
                                disabled="#{empty comptypeAttributesController.selectedAttribute ? true : not comptypeAttributesController.canDelete(comptypeAttributesController.selectedAttribute)}"/>
    
                            <p:commandButton id="editAttrButton" value="Edit" icon="ui-icon-pencil" 
                                action="#{comptypeAttributesController.prepareModifyPropertyPopUp()}" 
                                style="float: right; margin-right: 1ex;" update=":modifyPropertyValueForm :modifyArtifactForm" 
                                disabled="#{empty comptypeAttributesController.selectedAttribute ? true : not comptypeAttributesController.canEdit(comptypeAttributesController.selectedAttribute)}"/>
    
                            <p:commandButton id="addButton" value="Add" type="button" icon="ui-icon-plus" 
                                style="float: right; margin-right: 1ex;" disabled="true" />
                            <p:menu overlay="true" trigger="addButton" my="left bottom" at="left top">
                                <p:menuitem value="Device Type Property" oncomplete="PF('addPropertyValue').show();" 
                                    actionListener="#{comptypeAttributesController.prepareForPropertyValueAdd}" 
                                    update=":addPropertyValueForm:addPropertyValue" />
                                <p:menuitem value="Installation Slot Property" oncomplete="PF('installationSlotProperty').show();" 
                                    actionListener="#{comptypeAttributesController.prepareForSlotPropertyAdd()}" 
                                    update=":installationSlotPropertyForm:installationSlotProperty" />
                                <p:menuitem value="Device Instance Property" oncomplete="PF('deviceInstanceProperty').show();" 
                                    actionListener="#{comptypeAttributesController.prepareForDevicePropertyAdd()}" 
                                    update=":deviceInstancePropertyForm:deviceInstanceProperty" />
                                <p:menuitem value="Tag" oncomplete="PF('deviceTypeTag').show();" update=":deviceTypeTagForm" 
                                    actionListener="#{comptypeAttributesController.prepareForTagAdd}" />
                                <p:menuitem value="Artifact" oncomplete="PF('addArtifact').show();" 
                                    actionListener="#{comptypeAttributesController.prepareForArtifactAdd}" 
                                    update=":addArtifactForm:addArtifact" />
                            </p:menu>
                        </p:fieldset>
                    </p:column>
                </p:row>
            </p:panelGrid>
        </h:form>

        <script type="text/javascript">
            jQuery(window).resize(function() {
                adjustTableHights();
                adjustFieldsetHeight('#deviceTypesForm\\:devTypeFieldset');
                adjustFieldsetHeight('#deviceTypesForm\\:propFieldset');
            });

            jQuery(document).ready(function() {
                adjustTableHights();
                adjustFieldsetHeight('#deviceTypesForm\\:devTypeFieldset');
                adjustFieldsetHeight('#deviceTypesForm\\:propFieldset');
            });
            
            <!-- 
            // prevent focus of the first element, select the first button (Cancel) instead
            // http://forum.primefaces.org/viewtopic.php?f=3&t=29050
            // --> 
            PrimeFaces.widget.Dialog.prototype.applyFocus = function() {
                if (this.id == "addPropertyValueForm:addPropertyValue" 
                        || this.id == "installationSlotPropertyForm:installationSlotProperty"
                        || this.id == "deviceInstancePropertyForm:deviceInstanceProperty") {
                    this.jq.find(':button:input:visible:enabled:first').focus();
                } else {
                    this.jq.find(':not(:submit):not(:button):input:visible:enabled:first').focus();
                }
            }

        </script>

        <ui:include src="/resources/dialogs/delete-confirmation.xhtml" >
            <ui:param name="formId" value="deleteDeviceTypeForm" />
            <ui:param name="dialogTitle" value="Delete device type" />
            <ui:param name="widgetName" value="deleteDeviceType" />
            <ui:param name="controller" value="#{componentTypeManager}" />
            <ui:param name="submitHandler" value="onDelete" />
            <ui:param name="formToUpdate" value=":deviceTypesForm:deviceTypeTable :deviceTypesForm:deleteButton :deviceTypesForm:editButton" />
            <ui:param name="resetFilter" value="PF('deviceTypeTableVar').filter(); clearDeviceTypeAttributes();" />
            <ui:param name="entityType" value="this device type" />
        </ui:include>

        <ui:include src="/resources/dialogs/device-type.xhtml">
            <ui:param name="formId" value="addDeviceTypeForm" />
            <ui:param name="dialogTitle" value="Add Device Type" />
            <ui:param name="widgetName" value="addDeviceType" />
            <ui:param name="submitHandler" value="onAdd" />
        </ui:include>

        <ui:include src="/resources/dialogs/device-type.xhtml">
            <ui:param name="formId" value="editDeviceTypeForm" />
            <ui:param name="dialogTitle" value="Edit Device Type" />
            <ui:param name="widgetName" value="editDeviceType" />
            <ui:param name="submitHandler" value="onChange" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-value.xhtml" >
            <ui:param name="formId" value="modifyPropertyValueForm" />
            <ui:param name="dialogTitle" value="Modify device type property" />
            <ui:param name="widgetName" value="modifyPropertyValue" />
            <ui:param name="controller" value="#{comptypeAttributesController}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').filter();" />
            <ui:param name="submitHandler" value="modifyPropertyValue" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml" >
            <ui:param name="formId" value="modifyArtifactForm" />
            <ui:param name="dialogTitle" value="Modify device type artifact" />
            <ui:param name="widgetName" value="modifyArtifact" />
            <ui:param name="controller" value="#{comptypeAttributesController}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').filter();" />
            <ui:param name="submitHandler" value="modifyArtifact" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/multi-property-value.xhtml" >
            <ui:param name="formId" value="addPropertyValueForm" />
            <ui:param name="dialogTitle" value="Add new device type property" />
            <ui:param name="widgetName" value="addPropertyValue" />
            <ui:param name="controller" value="#{comptypeAttributesController}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').filter();" />
            <ui:param name="submitHandler" value="saveMultiplePropertyValues" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-definition.xhtml" >
            <ui:param name="formId" value="installationSlotPropertyForm" />
            <ui:param name="dialogTitle" value="Add new installation slot property" />
            <ui:param name="widgetName" value="installationSlotProperty" />
            <ui:param name="controller" value="#{comptypeAttributesController}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').filter();" />
            <ui:param name="submitHandler" value="addNewPropertyValueDefs" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-definition.xhtml" >
            <ui:param name="formId" value="deviceInstancePropertyForm" />
            <ui:param name="dialogTitle" value="Add new device instance property" />
            <ui:param name="widgetName" value="deviceInstanceProperty" />
            <ui:param name="controller" value="#{comptypeAttributesController}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').filter();" />
            <ui:param name="submitHandler" value="addNewPropertyValueDefs" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/tag.xhtml" >
            <ui:param name="formId" value="deviceTypeTagForm" />
            <ui:param name="dialogTitle" value="Add new device type tag" />
            <ui:param name="widgetName" value="deviceTypeTag" />
            <ui:param name="controller" value="#{comptypeAttributesController}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').filter();" />
            <ui:param name="submitHandler" value="addNewTag" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml" >
            <ui:param name="formId" value="addArtifactForm" />
            <ui:param name="dialogTitle" value="Add new device type artifact" />
            <ui:param name="widgetName" value="addArtifact" />
            <ui:param name="controller" value="#{comptypeAttributesController}" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').filter();" />
            <ui:param name="submitHandler" value="addNewArtifact" />
            <ui:param name="componentToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-confirmation.xhtml" >
            <ui:param name="formId" value="deleteAttributeForm" />
            <ui:param name="dialogTitle" value="Delete attribute" />
            <ui:param name="widgetName" value="deleteAttribute" />
            <ui:param name="controller" value="#{comptypeAttributesController}" />
            <ui:param name="submitHandler" value="deleteAttribute" />
            <ui:param name="resetFilter" value="PF('attributesDataTable').filter();" />
            <ui:param name="formToUpdate" value=":deviceTypesForm:attributesDataTable:attributesDataTable :deviceTypesForm:editAttrButton :deviceTypesForm:deleteAttrButton" />
            <ui:param name="entityType" value="selected attribute" />
        </ui:include>        
    </ui:define>
</ui:composition>
