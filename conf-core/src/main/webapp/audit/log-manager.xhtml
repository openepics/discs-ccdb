<ui:composition template="/template/template.xhtml" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui">

    <ui:define name="content">
        <h:form id="logsForm">
            <p:fieldset legend="Log" style="padding-bottom: 1em;">

                <p:dataTable widgetVar="logTableVar" var="auditRecord" id="logTable" value="#{auditManager.auditRecords}" 
                        resizableColumns="true" style="table-layout: fixed; word-wrap: break-word;" 
                        filteredValue="#{auditManager.filteredAuditRecords}" rows="15" paginator="true" 
                        paginatorPosition="bottom">
                    <p:ajax event="filter" ignoreAutoUpdate="true"/>

                    <p:column headerText="Timestamp" filterBy="#{auditRecord.logTimeFormatted}" 
                            sortBy="#{auditRecord.logTime}" filterMatchMode="contains">
                        <h:outputText value="#{auditRecord.logTimeFormatted}" />
                    </p:column>

                    <p:column headerText="User" sortBy="#{auditRecord.user}" filterBy="#{auditRecord.user}">
                        <h:outputText value="#{auditRecord.user}" />
                    </p:column>

                    <p:column headerText="Operation" sortBy="#{auditRecord.oper}" filterBy="#{auditRecord.oper}" 
                            filterMatchMode="exact" filterOptions="#{auditManager.auditOperations}">
                        <h:outputText value="#{auditRecord.oper}" />
                    </p:column>

                    <p:column headerText="Entity Name" sortBy="#{auditRecord.entityKey}" filterBy="#{auditRecord.entityKey}">
                        <h:outputText value="#{auditRecord.entityKey}" />
                    </p:column>

                    <p:column headerText="Entity Type" sortBy="#{auditRecord.entityType}" filterBy="#{auditRecord.entityType}" 
                            filterMatchMode="exact" filterOptions="#{auditManager.entityTypes}">
                        <h:outputText value="#{auditRecord.entityType}" />
                    </p:column>

                    <p:column headerText="Entity ID" sortBy="#{auditRecord.entityId}" filterBy="#{auditRecord.entityId}">
                        <h:outputText value="#{auditRecord.entityId}" />
                    </p:column>

                    <p:column headerText="Change" sortBy="#{auditRecord.entry}" filterBy="#{auditRecord.entry}" filterMatchMode="contains">
                        <p:commandLink id="logDetails" update=":logsForm:logDetailsPanel" action="#{auditManager.handleDetails()}" 
                                oncomplete="var ovl=PF('overlay');var cfg=ovl.cfg;cfg.target='#{component.clientId}';ovl.refresh(cfg);ovl.show();">
                            <f:setPropertyActionListener target="#{auditManager.displayRecord}" value="#{auditRecord}" />
                            <h:outputText value="#{auditRecord.entry.length() lt 46 ? auditRecord.entry : auditRecord.entry.substring(0,45).concat('...')}" />
                        </p:commandLink>
                    </p:column>
                </p:dataTable>

            </p:fieldset>

            <p:overlayPanel widgetVar="overlay" for="logTable" dismissable="true" showCloseIcon="true">
                <p:outputPanel id="logDetailsPanel">
                    <p:panel rendered="#{not empty auditManager.formattedDetails}">
                        <f:facet name="header">
                            <h:outputText value="Entry details" />
                        </f:facet>
                        <h:outputText value="#{auditManager.formattedDetails}" escape="false" 
                                style="font-family: monospace; white-space:pre;" />
                    </p:panel>
                </p:outputPanel>
            </p:overlayPanel>

        </h:form>
    </ui:define>
</ui:composition>