<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    template="/template/template.xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html">

    <ui:define name="content">
        <h:form id="hierarchies">
            <script type="text/javascript">
                //<![CDATA[
                function setRightColumnWidths() {
                    var em = emHeight();
                    var rightColumnsWidth = $('#hierarchies').outerWidth() - $('#hierarchies\\:treeColumn').outerWidth(true) - 2*em;
                    $('#hierarchies\\:attributesColumn').css({"max-width":rightColumnsWidth});
                    $('#hierarchies\\:relationsColumn').css({"max-width":rightColumnsWidth});
                    $('#hierarchies\\:installationColumn').css({"max-width":rightColumnsWidth});
                    $('#hierarchies\\:hierarchiesEmptyColumn').css({"max-width":rightColumnsWidth});
                }
                function resizeHierarchyTrees() {
                    var menusHeight = $('#top').outerHeight(true);
                    var columnNameHeight = $('#hierarchies\\:hierarchyTabs\\:tree\\:name').outerHeight(true);
                    columnNameHeight = Math.max(columnNameHeight, 
                                $('#hierarchies\\:hierarchyTabs\\:powersTree\\:powersName').outerHeight(true));
                    columnNameHeight = Math.max(columnNameHeight, 
                            $('#hierarchies\\:hierarchyTabs\\:controlsTree\\:ctrlName').outerHeight(true));
                    var headerHeight = columnNameHeight
                                        + $('#hierarchies\\:treeFieldSet legend').outerHeight(true)
                                        + $('#hierarchies\\:hierarchyTabs div.ui-tabs-navscroller').outerHeight(true);
                    if (headerHeight != null) {
                        var em = emHeight();
                        var totalMenusHeight = menusHeight + headerHeight + 7.5*em;
                        $('#hierarchies\\:hierarchyTabs\\:tree .ui-treetable-scrollable-body').css({"height":window.innerHeight-totalMenusHeight});
                        $('#hierarchies\\:hierarchyTabs\\:powersTree .ui-treetable-scrollable-body').css({"height":window.innerHeight-totalMenusHeight});
                        $('#hierarchies\\:hierarchyTabs\\:controlsTree .ui-treetable-scrollable-body').css({"height":window.innerHeight-totalMenusHeight});
                    }
                }
                function resizeEmptyColumnInHierarchies() {
                    var menusHeight = $('#top').outerHeight(true);
                    var em = emHeight();
                    var slotAttributesFieldSet = $('#hierarchies\\:slotAttributes').outerHeight(true);
                    var slotRelationsFieldSet = $('#hierarchies\\:relationsTable').outerHeight(true);
                    var installationDetailsFieldSet = $('#hierarchies\\:installationDetails').parent().outerHeight(true);

                    if (installationDetailsFieldSet == null) { 
                        installationDetails = 0;
                    }

                    var totalHeight = menusHeight + slotAttributesFieldSet + slotRelationsFieldSet + installationDetailsFieldSet + 4*em;

                    $('#hierarchies\\:hierarchiesEmptyColumn').css({"height":window.innerHeight-totalHeight});
                }
                function hierarchiesResizeAttributes() {
                    var attributesTableHeight = $("#attributesTable .hierarchies-attributes-cell").outerHeight(true);
                    var attributesTableHeaderHeight = $("#attributesTable .hierarchies-attributes-cell .ui-datatable-scrollable-header").outerHeight(true);
                    var attributesTableBodyHeight = attributesTableHeight - attributesTableHeaderHeight;
                    $('#attributesTable .hierarchies-attributes-cell .ui-datatable-scrollable-body').css({"max-height":attributesTableBodyHeight});
                }
                function hierarchiesResizeAll() {
                    resizeHierarchyTrees();
                    resizeEmptyColumnInHierarchies();
                    hierarchiesResizeAttributes();
                }
                function getVisibleTree() {
                    var visibleTreeTable = PF('hierarchyWidget');
                    if (PF('powersWidget').jq.is(':visible')) {
                    	visibleTreeTable = PF('powersWidget');
                    }
                    if (PF('ctrlWidget').jq.is(':visible')) {
                        visibleTreeTable = PF('ctrlWidget');
                    }
                    return visibleTreeTable;
                }
                function clearRelatedFilters() {
                    PF('attributesWidget').clearFilters();
                    PF('relationshipsWidget').clearFilters();
                }
            // ]]>
            </script>
            <p:growl showDetail="true" globalOnly="true" autoUpdate="true" />
            <p:panelGrid id="hierarchiesContainer" style="width: 100%;" styleClass="noBorders">
                <p:row>
                    <p:column rowspan="4" id="treeColumn">
                        <p:fieldset id="treeFieldSet" legend="Slots">
                            <p:tabView scrollable="true" id="hierarchyTabs" style="width: 35em;">
                                <p:ajax event="tabChange" listener="#{hierarchiesController.onTabChange}" 
                                    update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton 
                                        :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton 
                                        :hierarchies:installationDetails :hierarchies:slotAttributes 
                                        :hierarchies:addRelationship :hierarchies:hierarchyTabs:tree 
                                        :hierarchies:hierarchyTabs:powersTree :hierarchies:hierarchyTabs:controlsTree 
                                        :hierarchies:clipboardOperations" 
                                    oncomplete="resizeHierarchyTrees();clearRelatedFilters();" />

                                <p:tab id="INCLUDES" title="Contains">
                                    <p:treeTable id="tree" value="#{hierarchiesController.rootNode}" var="installationSlot" 
                                             selectionMode="multiple" selection="#{hierarchiesController.selectedIncludesNodes}" 
                                             scrollable="true" scrollWidth="auto" rowStyleClass="treeRows" 
                                             style="width: 35em;" widgetVar="hierarchyWidget">
                                         <p:ajax event="select" listener="#{hierarchiesController.onNodeSelect}" 
                                             update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton 
                                                     :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton 
                                                     :hierarchies:installationDetails :hierarchies:slotAttributes 
                                                     :hierarchies:addRelationship :hierarchies:clipboardOperations" 
                                             oncomplete="resizeEmptyColumnInHierarchies();hierarchiesResizeAttributes();clearRelatedFilters();" />
                                         <p:ajax event="unselect" listener="#{hierarchiesController.onNodeUnselect}" 
                                             update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton 
                                                     :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton 
                                                     :hierarchies:installationDetails :hierarchies:slotAttributes 
                                                     :hierarchies:addRelationship" 
                                             oncomplete="resizeEmptyColumnInHierarchies();clearRelatedFilters();" />
                                         <p:ajax event="expand" listener="#{hierarchiesController.onContainsExpand}" />
                
                                         <p:column id="name" headerText="Name">
                                             <h:outputText value="" rendered="#{installationSlot.hostingSlot}" 
                                                 style="display:inline-block; vertical-align:bottom !important" 
                                                 styleClass="ui-icon ui-icon-wrench" />
                                             <h:outputText value="" rendered="#{!installationSlot.hostingSlot}" 
                                                 style="display:inline-block; vertical-align:bottom !important" 
                                                 styleClass="ui-icon ui-icon-folder-collapsed" />
                                             <h:outputText value="#{installationSlot.name}" title="#{installationSlot.description}" />
                                             <h:outputText value="" rendered="#{installationSlot.inClipboard}" 
                                                 style="display:inline-block; vertical-align:bottom !important; margin-right: 1.2em; float: right;" 
                                                 styleClass="ui-icon ui-icon-clipboard" />
                                         </p:column>
                                     </p:treeTable>                                
                                </p:tab>
                                <p:tab id="CONTROLS" title="Controls">
                                    <p:treeTable id="controlsTree" value="#{hierarchiesController.controlsRoot}" var="ctrlSlot" 
                                             selectionMode="multiple" selection="#{hierarchiesController.selectedControlsNodes}" 
                                             scrollable="true" scrollWidth="auto" rowStyleClass="treeRows" 
                                             style="width: 35em;"  widgetVar="ctrlWidget">
                                         <p:ajax event="select" listener="#{hierarchiesController.onNodeSelect}" 
                                             update=":hierarchies:relationsTable :hierarchies:installationDetails 
                                                     :hierarchies:slotAttributes :hierarchies:addRelationship" 
                                             oncomplete="resizeEmptyColumnInHierarchies();hierarchiesResizeAttributes();clearRelatedFilters();" />
                                         <p:ajax event="unselect" listener="#{hierarchiesController.onNodeUnselect}" 
                                             update=":hierarchies:relationsTable :hierarchies:installationDetails 
                                                     :hierarchies:slotAttributes :hierarchies:addRelationship" 
                                             oncomplete="resizeEmptyColumnInHierarchies();clearRelatedFilters();" />
                                         <p:ajax event="expand" listener="#{hierarchiesController.onControlsExpand}" />
                
                                         <p:column id="ctrlName" headerText="Name">
                                             <h:outputText value="" rendered="#{ctrlSlot.hostingSlot}" 
                                                 style="display:inline-block; vertical-align:bottom !important" 
                                                 styleClass="ui-icon ui-icon-wrench" />
                                             <h:outputText value="" rendered="#{!ctrlSlot.hostingSlot}" 
                                                 style="display:inline-block; vertical-align:bottom !important" 
                                                 styleClass="ui-icon ui-icon-folder-collapsed" />
                                             <h:outputText value="#{ctrlSlot.name}" title="#{ctrlSlot.description}" />
                                         </p:column>
                                     </p:treeTable>                                
                                </p:tab>
                                <p:tab id="POWERS" title="Powers">
                                    <p:treeTable id="powersTree" value="#{hierarchiesController.powersRoot}" var="powerSlot" 
                                             selectionMode="multiple" selection="#{hierarchiesController.selectedPowersNodes}" 
                                             scrollable="true" scrollWidth="auto" rowStyleClass="treeRows" 
                                             style="width: 35em;"  widgetVar="powersWidget">
                                         <p:ajax event="select" listener="#{hierarchiesController.onNodeSelect}" 
                                             update=":hierarchies:relationsTable :hierarchies:installationDetails 
                                                     :hierarchies:slotAttributes :hierarchies:addRelationship" 
                                             oncomplete="resizeEmptyColumnInHierarchies();hierarchiesResizeAttributes();clearRelatedFilters();" />
                                         <p:ajax event="unselect" listener="#{hierarchiesController.onNodeUnselect}" 
                                             update=":hierarchies:relationsTable :hierarchies:installationDetails 
                                                     :hierarchies:slotAttributes :hierarchies:addRelationship" 
                                             oncomplete="resizeEmptyColumnInHierarchies();clearRelatedFilters();" />
                                         <p:ajax event="expand" listener="#{hierarchiesController.onPowersExpand}" />
                
                                         <p:column id="powersName" headerText="Name">
                                             <h:outputText value="" rendered="#{powerSlot.hostingSlot}" 
                                                 style="display:inline-block; vertical-align:bottom !important" 
                                                 styleClass="ui-icon ui-icon-wrench" />
                                             <h:outputText value="" rendered="#{!powerSlot.hostingSlot}" 
                                                 style="display:inline-block; vertical-align:bottom !important" 
                                                 styleClass="ui-icon ui-icon-folder-collapsed" />
                                             <h:outputText value="#{powerSlot.name}" title="#{powerSlot.description}" />
                                         </p:column>
                                     </p:treeTable>                                
                                </p:tab>
                            </p:tabView>

                            <p:menuButton value="C/P" id="clipboardOperations" style="float: right; margin-top: 1em;" 
                                disabled="#{not hierarchiesController.includesActive}">
                                <p:menuitem value="Cut" id="cutButton" icon="ui-icon-scissors" 
                                    title="Put selected items to clipboard for moving" 
                                    action="#{hierarchiesController.cutTreeNodes}" oncomplete="hierarchiesResizeAll();" 
                                    disabled="#{not hierarchiesController.includesActive or 
                                                    empty hierarchiesController.selectedIncludesNodes}" 
                                    update=":hierarchies:hierarchyTabs:tree" />
                                <p:menuitem value="Paste" id="pasteButton" icon="ui-icon-clipboard" 
                                    title="Paste into the selected parent" oncomplete="PF('pasteSlots').show();" 
                                    disabled="#{not hierarchiesController.includesActive 
                                                    or not hierarchiesController.singleNodeSelected 
                                                    or hierarchiesController.clipboardEmpty}" 
                                    action="#{hierarchiesController.checkPasteAction}"
                                    update=":pasteSlotsForm:pasteSlots" />
                            </p:menuButton>
                            <p:commandButton id="deleteButton" icon="ui-icon-trash" value="Delete" title="Delete" 
                                style="float: right; margin: 1em 1ex 0 0;" oncomplete="PF('deleteSlots').show();" 
                                disabled="#{not hierarchiesController.includesActive 
                                                or empty hierarchiesController.selectedIncludesNodes 
                                                or not hierarchiesController.nodesDeletable}" 
                                update=":deleteSlotsForm" actionListener="#{hierarchiesController.prepareDeletePopup()}" />
                            <p:commandButton id="downButton" icon="ui-icon-arrowthick-1-s" value="Down" title="Move down" 
                                style="float: right; margin: 1em 1ex 0 0;" 
                                oncomplete="hierarchiesResizeAll(); scrollSelectedIntoView(PF('hierarchyWidget'));" 
                                update=":hierarchies:hierarchyTabs:tree :hierarchies:downButton :hierarchies:upButton" 
                                disabled="#{not hierarchiesController.singleNodeSelected 
                                                or not hierarchiesController.includesActive 
                                                or hierarchiesController.singleSelectedSlotView.last}" 
                                actionListener="#{hierarchiesController.moveSlotDown()}" />
                            <p:commandButton id="upButton" icon="ui-icon-arrowthick-1-n" value="Up" title="Move up" 
                                style="float: right; margin: 1em 1ex 0 0;" 
                                oncomplete="hierarchiesResizeAll(); scrollSelectedIntoView(PF('hierarchyWidget'));" 
                                update=":hierarchies:hierarchyTabs:tree :hierarchies:upButton :hierarchies:downButton" 
                                disabled="#{not hierarchiesController.singleNodeSelected 
                                                or not hierarchiesController.includesActive 
                                                or hierarchiesController.singleSelectedSlotView.first}" 
                                actionListener="#{hierarchiesController.moveSlotUp()}" />
                            <p:commandButton id="editButton" icon="ui-icon-pencil" value="Edit" title="Edit" 
                                style="float: right; margin: 1em 1ex 0 0;" update=":editSlotForm:editSlotDialog" 
                                disabled="#{not hierarchiesController.singleNodeSelected or not hierarchiesController.includesActive}" 
                                oncomplete="PF('editSlotDialog').show();" 
                                actionListener="#{hierarchiesController.prepareEditPopup()}" />

                            <p:menuButton id="addButton" value="Add" style="float: right; margin: 1em 1ex 0 0;" 
                                    disabled="#{not hierarchiesController.includesActive 
                                                    or hierarchiesController.multipleNodesSelected}">
                                <p:menuitem value="Container" oncomplete="PF('addSlotDialog').show();" 
                                        actionListener="#{hierarchiesController.prepareContainerAddPopup}" 
                                        update=":addSlotForm" 
                                        disabled="#{hierarchiesController.multipleNodesSelected 
                                                        or hierarchiesController.selectedNodeSlot.hostingSlot}" />
                                <p:menuitem value="Installation slot" oncomplete="PF('addSlotDialog').show();" 
                                        actionListener="#{hierarchiesController.prepareInstallationSlotPopup}" 
                                        update=":addSlotForm" disabled="#{not hierarchiesController.singleNodeSelected}" />
                            </p:menuButton>
                        </p:fieldset>
                    </p:column>
                    <p:column id="attributesColumn" styleClass="alignTop" >
                        <p:fieldset id="slotAttributes" legend="#{hierarchiesController.selectedNodeSlot.hostingSlot 
                                ? hierarchiesController.selectedNodeSlot.componentType.name.concat(' installation slot attributes') 
                                : 'Container attributes'}">
                            <p:dataTable id="attributesTable" class="hierarchies-attributes-cell" emptyMessage="No element selected." 
                                    value="#{hierarchiesController.attributes}" var="attribute" scrollable="true" 
                                    style="width: 100%; overflow-y: hidden; max-height: 30%;" resizableColumns="true" 
                                    selection="#{hierarchiesController.selectedAttribute}" selectionMode="single" 
                                    filteredValue="#{hierarchiesController.filteredAttributes}" rowKey="#{attribute.id}"
                                    widgetVar="attributesWidget">
                                <p:ajax event="rowSelect" update=":hierarchies:deleteAttrButton :hierarchies:editAttrButton" />
                                <p:ajax event="rowUnselect" update=":hierarchies:deleteAttrButton :hierarchies:editAttrButton" />

                                <p:column headerText="Entity" sortBy="#{attribute.parent}" filterBy="#{attribute.parent}" 
                                        filterMatchMode="contains" >
                                    <h:outputText value="#{attribute.parent}" />
                                </p:column>
                                    
                                <p:column headerText="Name" sortBy="#{attribute.name}" filterBy="#{attribute.name}" 
                                        filterMatchMode="contains">
                                    <h:outputText value="#{attribute.name}" />
                                </p:column>

                                <p:column headerText="Value" sortBy="#{attribute.value}" 
                                        filterBy="#{attribute.value}" filterMatchMode="contains">
                                    <h:outputLink rendered="#{attribute.hasURL}" target="_blank" value="#{attribute.value}" title="Go to URL">
                                        <h:outputText value="#{attribute.value}" style="text-decoration: underline;" />
                                    </h:outputLink>
                                    <h:outputText value="#{!empty attribute.value ? attribute.value : '-'}" rendered="#{not attribute.hasURL}" />
                                    <p:commandLink ajax="false" title="Download" rendered="#{attribute.hasFile}" style="margin-left: 1ex;">
                                        <h:outputText styleClass="ui-icon ui-icon-arrowthick-1-s" style="display: inline-block !important; margin-right: 6px;" />
                                        <f:setPropertyActionListener value="#{attribute}" target="#{hierarchiesController.selectedAttribute}" />
                                        <p:fileDownload value="#{hierarchiesController.downloadFile}" />
                                    </p:commandLink>
                                </p:column>

                                <p:column headerText="Unit" sortBy="#{attribute.unit.name}" filterBy="#{attribute.unit.name}" 
                                        filterMatchMode="contains">
                                    <h:outputLink rendered="#{!empty attribute.unit}" 
                                            value="#{request.contextPath}/units.xhtml?id=#{attribute.unit.id}">
                                        <h:outputText value="#{attribute.unit.name}" style="text-decoration: underline;" />
                                    </h:outputLink>
                                    <h:outputText value="-" rendered="#{empty attribute.unit}" />
                                </p:column>

                                <p:column headerText="Kind" sortBy="#{attribute.kind.toString()}" 
                                        filterBy="#{attribute.kind}" filterMatchMode="exact" 
                                        filterOptions="#{hierarchiesController.attributeKinds}">
                                    <h:outputText value="#{attribute.kind.toString()}" />
                                </p:column>

                                <p:column headerText="Data type" sortBy="#{attribute.type.name}" 
                                        filterBy="#{attribute.type.name}" filterMatchMode="contains">
                                    <h:outputText value="#{attribute.type.name}" />
                                </p:column>
                            </p:dataTable>

                            <p:commandButton id="deleteAttrButton" value="Delete" icon="ui-icon-trash" 
                                style="float: right; margin-top: 1em;" oncomplete="PF('deleteAttribute').show();" 
                                disabled="#{!hierarchiesController.canDeleteAttribute()}" />
                            <p:commandButton id="editAttrButton" value="Edit" icon="ui-icon-pencil" 
                                action="#{hierarchiesController.prepareModifyAttributePopup}" 
                                style="float: right; margin: 1em 1ex 0 0;" update=":modifyPropertyValueForm :modifyArtifactForm" 
                                disabled="#{!hierarchiesController.canEditAttribute()}" />
                            <p:menuButton id="addAttrButton" value="Add" style="margin: 1em 1ex 0 0; float: right;" 
                                    disabled="#{not hierarchiesController.singleNodeSelected}">
                                <p:menuitem value="Container property" oncomplete="PF('addPropertyValue').show();" 
                                        actionListener="#{hierarchiesController.prepareForPropertyValueAdd}" 
                                        disabled="#{hierarchiesController.selectedNodeSlot.hostingSlot}" 
                                        update=":addPropertyValueForm:addPropertyValue" />
                                <p:menuitem value="Tag" oncomplete="PF('containerTag').show();" update=":containerTagForm" 
                                        actionListener="#{hierarchiesController.prepareForTagAdd}" />
                                <p:menuitem value="Artifact" oncomplete="PF('addArtifact').show();" 
                                        actionListener="#{hierarchiesController.prepareForArtifactAdd}" 
                                        update=":addArtifactForm:addArtifact" />
                            </p:menuButton>
                        </p:fieldset>

                    </p:column>
                </p:row>
                <p:row>
                    <p:column id="relationsColumn" styleClass="alignTop">
                        <p:fieldset id="relationsTable" legend="Slot relationships">
                            <p:dataTable value="#{hierarchiesController.relationships}" id="relationshipTable"
                                    style="width: 100%; overflow-y: hidden; max-height: 324px;" var="relationship" 
                                    emptyMessage="No element selected." scrollable="true" class="hierarchies-attributes-cell" 
                                    filteredValue="#{hierarchiesController.filteredRelationships}"
                                    selectionMode="single" rowKey="#{relationship.slotPair.id}" 
                                    selection="#{hierarchiesController.selectedRelationship}" 
                                    widgetVar="relationshipsWidget">
                                <p:ajax event="rowSelect" update=":hierarchies:deleteRelationship" />
                                <p:ajax event="rowUnselect" update=":hierarchies:deleteRelationship" />

                                <p:column headerText="Source" sortBy="#{relationship.sourceSlotName}">
                                    <h:outputText value="#{relationship.sourceSlotName}" />
                                </p:column>

                                <p:column headerText="Relationship" sortBy="#{relationship.relationshipName}" 
                                        filterOptions="#{hierarchiesController.relationshipTypes}" 
                                        filterBy="#{relationship.relationshipName}" filterMatchMode="exact">
                                    <h:outputText value="#{relationship.relationshipName}" />
                                </p:column>

                                <p:column headerText="Target" sortBy="#{relationship.targetSlotName}" 
                                        filterBy="#{relationship.targetSlotName}" filterMatchMode="contains">
                                    <p:commandLink action="#{hierarchiesController.selectNode(relationship.slot.id)}" 
                                            rendered="#{hierarchiesController.includesActive}" 
                                            update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton 
                                                :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton 
                                                :hierarchies:installationDetails :hierarchies:slotAttributes 
                                                :hierarchies:addRelationship :hierarchies:hierarchyTabs:tree"
                                            oncomplete="hierarchiesResizeAll();scrollSelectedIntoView(getVisibleTree());">
                                        <h:outputText value="#{relationship.targetSlotName}" 
                                            style="text-decoration: underline;" />
                                    </p:commandLink>
                                    <h:outputText value="#{relationship.targetSlotName}" 
                                        rendered="#{not hierarchiesController.includesActive}" />
                                </p:column>
                            </p:dataTable>

                            <p:commandButton id="deleteRelationship" value="Delete" icon="ui-icon-trash" 
                                style="margin-top: 1em; float: right;" disabled="#{empty hierarchiesController.selectedRelationship}" 
                                oncomplete="PF('deleteRelationship').show();" />
                            <p:commandButton value="Add" oncomplete="PF('addSlotRelationship').show()" id="addRelationship" 
                                icon="ui-icon-plus" disabled="#{not hierarchiesController.singleNodeSelected}"
                                style="margin: 1em 1ex 0 0; float: right;" update=":addSlotRelationshipForm" 
                                actionListener="#{hierarchiesController.prepareAddRelationshipPopup}" />
                        </p:fieldset>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column id="installationColumn">
                        <p:fieldset id="installationDetails" legend="Installation details">
                            <p:dataTable id="installationTable" value="#{hierarchiesController.installationRecords}" 
                                    var="installationRecord" style="width: 100%;" selectionMode="single" 
                                    selection="#{hierarchiesController.selectedInstallationView}"
                                    emptyMessage="No element selected." rowKey="#{installationRecord.slotName}">

                                <p:ajax event="rowSelect" update=":hierarchies:installDeviceBtn :hierarchies:uninstallDeviceBtn" />
                                <p:ajax event="rowUnselect" update=":hierarchies:installDeviceBtn :hierarchies:uninstallDeviceBtn" />

                                <p:column headerText="Installation slot" sortBy="#{installationRecord.slotName}">
                                    <h:outputText value="#{installationRecord.slotName}" />
                                </p:column>
                                <p:column headerText="Installed device inventory ID">
                                    <h:link outcome="deviceManager" value="#{installationRecord.deviceInventoryId}" 
                                            class="link" rendered="#{installationRecord.deviceInstalled}">
                                        <f:param name="id" value="#{installationRecord.installationRecord.device.id}" />
                                    </h:link>                                    
                                    <h:outputText value="-" rendered="#{not installationRecord.deviceInstalled}" />
                                </p:column>
                                <p:column headerText="Installation timestamp">
                                    <h:outputText value="#{installationRecord.installDate}" 
                                            rendered="#{installationRecord.deviceInstalled}">
                                        <f:convertDateTime pattern="#{msgs.timestampFormat}" />
                                    </h:outputText>
                                    <h:outputText value="Not installed" 
                                            rendered="#{not installationRecord.deviceInstalled}" />
                                </p:column>
                            </p:dataTable>
                            <p:commandButton title="Install device to the selected slot" id="installDeviceBtn" 
                                    value="Install" ajax="true" 
                                    actionListener="#{hierarchiesController.prepareUninstalledDevices}" 
                                    style="margin-top: 1em; float: right;" update=":hierarchies:installationDetails" 
                                    disabled="#{empty hierarchiesController.selectedInstallationView or 
                                            hierarchiesController.selectedInstallationView.deviceInstalled}"
                                    oncomplete="PF('installDevice').show();" />
                            <p:commandButton title="Uninstall selected device" label="Uninstall" value="Uninstall" 
                                type="button" onclick="PF('uninstallConfirm').show();" id="uninstallDeviceBtn" 
                                style="margin: 1em 1ex 0 0; float: right;" update=":hierarchies:installationDetails" 
                                disabled="#{empty hierarchiesController.selectedInstallationView or 
                                            not hierarchiesController.selectedInstallationView.deviceInstalled}" />
                        </p:fieldset>
                    </p:column>
                </p:row>
                <p:row>
                    <!-- 
                    Added row with 100% width to fill in the space below other tables and to push tables
                    close together
                      -->
                    <p:column id="hierarchiesEmptyColumn">
                    </p:column>
                </p:row>
            </p:panelGrid>
        </h:form>

        <ui:include src="/resources/dialogs/install-device.xhtml">
            <ui:param name="formId" value="installDeviceForm" />
            <ui:param name="dialogTitle" value="Select device instance" />
            <ui:param name="widgetName" value="installDevice" />
            <ui:param name="slot" value="#{hierarchiesController.selectedNodeSlot}" />
            <ui:param name="componentToUpdate"
                value=":hierarchies:slotAttributes :hierarchies:relationsTable :hierarchies:installationDetails" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-slots-confirmation.xhtml" >
            <ui:param name="formId" value="deleteSlotsForm" />
            <ui:param name="dialogTitle" value="#{hierarchiesController.numberOfSlotsToDelete gt 1 
                                                        ? 'Delete slots' : 'Delete slot'}" />
            <ui:param name="widgetName" value="deleteSlots" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="onSlotsDelete" />
            <ui:param name="formToUpdate" value=":hierarchies:hierarchyTabs:tree :hierarchies:deleteButton 
                    :hierarchies:slotAttributes :hierarchies:relationsTable :hierarchies:installationDetails 
                    :hierarchies:downButton :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton" />
            <ui:param name="resizeContent" value="hierarchiesResizeAll();" />
            <ui:param name="entityType" value="#{hierarchiesController.numberOfSlotsToDelete gt 1 
                                                        ? 'the following slots:' : 'selected slot?'}" />
            <ui:param name="isTableDisplayed" value="#{(hierarchiesController.numberOfSlotsToDelete gt 1)}" />
            <ui:param name="slotsToDelete" value="#{hierarchiesController.slotsToDelete}" />
        </ui:include>

        <ui:include src="/resources/dialogs/paste-slots-confirmation.xhtml" >
            <ui:param name="formId" value="pasteSlotsForm" />
            <ui:param name="widgetName" value="pasteSlots" />
            <ui:param name="formsToUpdate" value=":hierarchies:cutButton :hierarchies:pasteButton 
                    :hierarchies:hierarchyTabs:tree" />
            <ui:param name="closeDialogActions" value="hierarchiesResizeAll();" />
        </ui:include>

        <ui:include src="/resources/dialogs/add-or-modify-slot.xhtml">
            <ui:param name="formId" value="editSlotForm" />
            <ui:param name="widgetName" value="editSlotDialog" />
            <ui:param name="dialogTitle" value="Edit #{hierarchiesController.selectedNodeSlot.hostingSlot 
                                                    ? 'installation slot' : 'container'}" />
            <ui:param name="submitHandler" value="onSlotModify" />
        </ui:include>

        <ui:include src="/resources/dialogs/add-or-modify-slot.xhtml">
            <ui:param name="formId" value="addSlotForm" />
            <ui:param name="widgetName" value="addSlotDialog" />
            <ui:param name="dialogTitle" value="Add #{hierarchiesController.installationSlot 
                                                    ? 'installation slot' : 'container'}" />
            <ui:param name="submitHandler" value="onSlotAdd" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-confirmation.xhtml">
            <ui:param name="formId" value="deleteAttributeForm" />
            <ui:param name="dialogTitle" value="Delete attribute" />
            <ui:param name="widgetName" value="deleteAttribute" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="deleteAttribute" />
            <ui:param name="formToUpdate" value=":hierarchies:slotAttributes" />
            <ui:param name="entityType" value="selected attribute" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-value.xhtml">
            <ui:param name="formId" value="modifyPropertyValueForm" />
            <ui:param name="dialogTitle" value="Modify #{hierarchiesController.selectedNodeSlot.hostingSlot 
                                                    ? 'installation slot' : 'container'} property" />
            <ui:param name="widgetName" value="modifyPropertyValue" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="modifyPropertyValue" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-value.xhtml">
            <ui:param name="formId" value="addPropertyValueForm" />
            <ui:param name="dialogTitle" value="Add new container property" />
            <ui:param name="widgetName" value="addPropertyValue" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="addNewPropertyValue" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
        </ui:include>

        <ui:include src="/resources/dialogs/tag.xhtml" >
            <ui:param name="formId" value="containerTagForm" />
            <ui:param name="dialogTitle" value="Add new #{hierarchiesController.selectedNodeSlot.hostingSlot 
                                                    ? 'installation slot' : 'container'} tag" />
            <ui:param name="widgetName" value="containerTag" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="addNewTag" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml" >
            <ui:param name="formId" value="addArtifactForm" />
            <ui:param name="dialogTitle" value="Add new #{hierarchiesController.selectedNodeSlot.hostingSlot 
                                                    ? 'installation slot' : 'container'} artifact" />
            <ui:param name="widgetName" value="addArtifact" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="addNewArtifact" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml">
            <ui:param name="formId" value="modifyArtifactForm" />
            <ui:param name="dialogTitle" value="Modify #{hierarchiesController.selectedNodeSlot.hostingSlot 
                                                    ? 'installation slot' : 'container'} artifact" />
            <ui:param name="widgetName" value="modifyArtifact" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="modifyArtifact" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-confirmation.xhtml">
            <ui:param name="formId" value="deleteRelationshipForm" />
            <ui:param name="dialogTitle" value="Delete relationship" />
            <ui:param name="widgetName" value="deleteRelationship" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="onRelationshipDelete" />
            <ui:param name="formToUpdate" value=":hierarchies:relationshipTable :hierarchies:deleteRelationship 
                    :hierarchies:hierarchyTabs:tree" />
            <ui:param name="entityType" value="selected relationship" />
        </ui:include>

        <ui:include src="/resources/dialogs/cannot-delete-relationship.xhtml" />
        <ui:include src="/resources/dialogs/slot-pair-loop-notification.xhtml" />
        <ui:include src="/resources/dialogs/add-relationship.xhtml" />
        <ui:include src="/resources/dialogs/uninstall-confirm.xhtml" />

        <script type="text/javascript">
            //<![CDATA[
            jQuery(window).resize(function() {
                hierarchiesResizeAll();
                scrollSelectedIntoView(PF('hierarchyWidget'));
                setRightColumnWidths();
            });

            jQuery(document).ready(function() {
                hierarchiesResizeAll();
                scrollSelectedIntoView(PF('hierarchyWidget'));
                setRightColumnWidths();
            });
            // PrimeFaces Shift-select workaround. Event is triggered on the last node. This is not a propert solution!
            PrimeFaces.widget.TreeTable.prototype.selectNodesInRange = function(node) {
                if (this.cursorNode) {
                    this.unselectAllNodes();

                    var currentNodeIndex = node.index(),
                    cursorNodeIndex = this.cursorNode.index(),
                    startIndex = (currentNodeIndex > cursorNodeIndex) ? cursorNodeIndex : currentNodeIndex,
                    endIndex = (currentNodeIndex > cursorNodeIndex) ? (currentNodeIndex + 1) : (cursorNodeIndex + 1),
                    nodes = this.tbody.children();

                    for (var i = startIndex ; i < endIndex; i++) {
                        this.selectNode(nodes.eq(i), (i != (endIndex - 1))); // fire event for the last node
                    }
                } else {
                    this.selectNode(node);
                }
            }; 
            // ]]>
        </script>
    </ui:define>
</ui:composition>