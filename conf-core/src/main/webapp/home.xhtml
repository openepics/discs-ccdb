<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    template="/template/template.xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html">

    <ui:define name="content">
        <h:form id="hierarchies">
            <script type="text/javascript">
                //<![CDATA[                         
                function hierarchiesResizeAll() {
                	clearRelatedFilters();
                }
                function getVisibleTree() {
                    var visibleTreeTable = PF('hierarchyWidget');
                    if (PF('powersWidget').jq.is(':visible')) {
                    	visibleTreeTable = PF('powersWidget');
                    }
                    if (PF('ctrlWidget').jq.is(':visible')) {
                        visibleTreeTable = PF('ctrlWidget');
                    }
                    return visibleTreeTable;
                }
                function clearRelatedFilters() {
                    PF('attributesWidget').clearFilters();
                    PF('relationshipsWidget').clearFilters();
                    PF('installationWidget').clearFilters();                    
                }
            // ]]>
            </script>
            <p:growl showDetail="true" globalOnly="true" autoUpdate="true" />
            <p:panelGrid id="hierarchiesContainer" styleClass="noBorders">
                <p:row>
                    <p:column rowspan="4" id="treeColumn">
                        <p:fieldset id="treeFieldSet" legend="Slots" style="box-sizing: border-box; height: calc(100vh - 7em)">
                        <div style="height: calc(100% - 3em)">
                            <p:tabView id="hierarchyTabs" style="width: 40em; height: 100%">
                                <p:ajax event="tabChange" listener="#{hierarchiesController.onTabChange}"
                                    update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton
                                        :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                                        :hierarchies:installationDetails :hierarchies:slotAttributes
                                        :hierarchies:addRelationship :hierarchies:hierarchyTabs:tree
                                        :hierarchies:hierarchyTabs:powersTree :hierarchies:hierarchyTabs:controlsTree
                                        :hierarchies:hierarchyTabs:connectsTree
                                        :hierarchies:clipboardOperations"                                    
                                    onstart="PF('statusDialog').show()" oncomplete="PF('statusDialog').hide(); hierarchiesResizeAll();" />
                                <p:tab id="INCLUDES" title="Contains" style="height: 100%">
                                    <p:inputText id="filterContainsTree" value="#{hierarchiesController.filterContainsTree}"
                                                 style="box-sizing: border-box; width:100%">
                                        <p:ajax event="keyup" delay="1000" listener="#{hierarchiesController.filterContainsTree()}"
                                         update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton
                                                        :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                                                        :hierarchies:installationDetails :hierarchies:slotAttributes
                                                        :hierarchies:addRelationship :hierarchies:hierarchyTabs:tree                                                        
                                                        :hierarchies:clipboardOperations"/>                                                 
                                    </p:inputText>
                                    <div style="height: calc(100% - 2em)">
                                        <p:treeTable id="tree" value="#{hierarchiesController.rootNode}" var="installationSlot"
                                                 selectionMode="multiple" selection="#{hierarchiesController.selectedIncludesNodes}"
                                                 scrollable="true" scrollWidth="100%" scrollHeight="100%" rowStyleClass="treeRows"
                                                 widgetVar="hierarchyWidget" nodeVar="slotNode">
                                            <p:ajax event="select" listener="#{hierarchiesController.onNodeSelect}"
                                                update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton
                                                        :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                                                        :hierarchies:installationDetails :hierarchies:slotAttributes
                                                        :hierarchies:addRelationship :hierarchies:clipboardOperations"
                                                oncomplete="hierarchiesResizeAll();" />
                                            <p:ajax event="unselect" listener="#{hierarchiesController.onNodeUnselect}"
                                                update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton
                                                        :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                                                        :hierarchies:installationDetails :hierarchies:slotAttributes
                                                        :hierarchies:addRelationship :hierarchies:clipboardOperations"
                                                oncomplete="hierarchiesResizeAll();" />
                                            <p:ajax event="expand" listener="#{hierarchiesController.onContainsExpand}" />
    
                                            <p:column id="name" headerText="Name" style="white-space: normal;">
                                                <h:outputText value="" rendered="#{installationSlot.hostingSlot}"
                                                    style="display:inline-block; vertical-align:bottom !important"
                                                    styleClass="ui-icon ui-icon-wrench" />
                                                <h:outputText value="" rendered="#{!installationSlot.hostingSlot}"
                                                    style="display:inline-block; vertical-align:bottom !important"
                                                    styleClass="ui-icon ui-icon-folder-collapsed" />
                                                <h:outputText value="#{installationSlot.name}" styleClass="#{hierarchiesController.calcNameClass(installationSlot)}"
                                                    title="#{installationSlot.description}#{installationSlot.hostingSlot ? ' ('.concat(installationSlot.deviceTypeName).concat(')') : ''}" />
                                                <p:link rendered="#{installationSlot.hostingSlot and hierarchiesController.linkToNaming(installationSlot)}" target="_blank" 
                                                        href="#{hierarchiesController.namingRedirectionUrl}#{installationSlot.name}" title="Open in Naming Service">
                                                    <h:outputText value="" rendered="#{installationSlot.hostingSlot}" 
                                                        style="display:inline-block; vertical-align:bottom !important; margin-left: 1ex;"
                                                        styleClass="ui-icon ui-icon-extlink"/>
                                                </p:link>
                                                <h:outputText value="" rendered="#{installationSlot.inClipboard or
                                                                                    (hierarchiesController.cliboardOperation == 'COPY'
                                                                                    and hierarchiesController.isAncestorNodeInClipboard(slotNode))}"
                                                    style="display:inline-block; vertical-align:bottom !important; float: right; right: 1.2em; position: relative;"
                                                    styleClass="ui-icon ui-icon-clipboard" />
                                                <h:outputText value="" rendered="#{hierarchiesController.cliboardOperation == 'COPY'
                                                                                    and (installationSlot.inClipboard
                                                                                        or hierarchiesController.isAncestorNodeInClipboard(slotNode))}"
                                                    style="display:inline-block; vertical-align:bottom !important; float: right; position: relative; right: 0; bottom: 0.15em; opacity: 0.7;"
                                                    styleClass="ui-icon ui-icon-clipboard" />
                                            </p:column>
                                        </p:treeTable>                                            
                                    </div>                                    
                                </p:tab>
                                <p:tab id="CONTROLS" title="Controls" style="height: 100%">
                                    <p:inputText id="filterControlsTree" value="#{hierarchiesController.filterControlsTree}"
                                                 style="box-sizing: border-box; width:100%">
                                        <p:ajax event="keyup" delay="1000" listener="#{hierarchiesController.filterControlsTree()}"
                                         update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton
                                                        :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                                                        :hierarchies:installationDetails :hierarchies:slotAttributes
                                                        :hierarchies:addRelationship :hierarchies:hierarchyTabs:controlsTree                                                        
                                                        :hierarchies:clipboardOperations"/>                                                 
                                    </p:inputText>
                                    <div style="height: calc(100% - 2em)">
                                        <p:treeTable id="controlsTree" value="#{hierarchiesController.controlsRoot}" var="ctrlSlot"
                                                 selectionMode="multiple" selection="#{hierarchiesController.selectedControlsNodes}"
                                                 scrollable="true" scrollWidth="100%" scrollHeight="100%" rowStyleClass="treeRows"
                                                 widgetVar="ctrlWidget">
                                                 
                                            <p:ajax event="select" listener="#{hierarchiesController.onNodeSelect}"
                                                    update=":hierarchies:relationsTable :hierarchies:installationDetails
                                                            :hierarchies:slotAttributes :hierarchies:addRelationship"
                                                    oncomplete="hierarchiesResizeAll();" />
                                            <p:ajax event="unselect" listener="#{hierarchiesController.onNodeUnselect}"
                                                    update=":hierarchies:relationsTable :hierarchies:installationDetails
                                                            :hierarchies:slotAttributes :hierarchies:addRelationship"
                                                    oncomplete="hierarchiesResizeAll();" />
                                            <p:ajax event="expand" listener="#{hierarchiesController.onControlsExpand}" />
    
                                            <p:column id="ctrlName" headerText="Name">
                                                <h:outputText value="" rendered="#{ctrlSlot.hostingSlot}"
                                                    style="display:inline-block; vertical-align:bottom !important"
                                                    styleClass="ui-icon ui-icon-wrench" />
                                                <h:outputText value="" rendered="#{!ctrlSlot.hostingSlot}"
                                                    style="display:inline-block; vertical-align:bottom !important"
                                                    styleClass="ui-icon ui-icon-folder-collapsed" />
                                                <h:outputText value="#{ctrlSlot.name}" styleClass="#{hierarchiesController.calcNameClass(ctrlSlot)}"
                                                    title="#{ctrlSlot.description}#{ctrlSlot.hostingSlot ? ' ('.concat(ctrlSlot.deviceTypeName).concat(')') : ''}" />
                                                <p:link rendered="#{ctrlSlot.hostingSlot and hierarchiesController.linkToNaming(ctrlSlot)}" target="_blank" 
                                                        href="#{hierarchiesController.namingRedirectionUrl}#{ctrlSlot.name}" title="Open in Naming Service">
                                                    <h:outputText value="" rendered="#{ctrlSlot.hostingSlot}" 
                                                        style="display:inline-block; vertical-align:bottom !important; margin-left: 1ex;"
                                                        styleClass="ui-icon ui-icon-extlink"/>
                                                </p:link>
                                            </p:column>
                                        </p:treeTable>
                                    </div>
                                </p:tab>
                                <p:tab id="POWERS" title="Powers" style="height: 100%">
                                    <p:inputText id="filterPowersTree" value="#{hierarchiesController.filterPowersTree}"
                                                 style="box-sizing: border-box; width:100%">
                                        <p:ajax event="keyup" delay="1000" listener="#{hierarchiesController.filterPowersTree()}"
                                         update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton
                                                        :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                                                        :hierarchies:installationDetails :hierarchies:slotAttributes
                                                        :hierarchies:addRelationship :hierarchies:hierarchyTabs:powersTree                                                        
                                                        :hierarchies:clipboardOperations"/>                                                 
                                    </p:inputText>
                                
                                    <div style="height: calc(100% - 2em)">
                                        <p:treeTable id="powersTree" value="#{hierarchiesController.powersRoot}" var="powerSlot"
                                                 selectionMode="multiple" selection="#{hierarchiesController.selectedPowersNodes}"
                                                 scrollable="true" scrollWidth="100%" scrollHeight="100%" rowStyleClass="treeRows"
                                                 widgetVar="powersWidget">
                                            <p:ajax event="select" listener="#{hierarchiesController.onNodeSelect}"
                                                    update=":hierarchies:relationsTable :hierarchies:installationDetails
                                                            :hierarchies:slotAttributes :hierarchies:addRelationship"
                                                    oncomplete="hierarchiesResizeAll();" />
                                            <p:ajax event="unselect" listener="#{hierarchiesController.onNodeUnselect}"
                                                    update=":hierarchies:relationsTable :hierarchies:installationDetails
                                                            :hierarchies:slotAttributes :hierarchies:addRelationship"
                                                    oncomplete="hierarchiesResizeAll();" />
                                            <p:ajax event="expand" listener="#{hierarchiesController.onPowersExpand}" />
    
                                            <p:column id="powersName" headerText="Name">
                                                <h:outputText value="" rendered="#{powerSlot.hostingSlot}"
                                                    style="display:inline-block; vertical-align:bottom !important"
                                                    styleClass="ui-icon ui-icon-wrench" />
                                                <h:outputText value="" rendered="#{!powerSlot.hostingSlot}"
                                                    style="display:inline-block; vertical-align:bottom !important"
                                                    styleClass="ui-icon ui-icon-folder-collapsed" />
                                                <h:outputText value="#{powerSlot.name}" styleClass="#{hierarchiesController.calcNameClass(powerSlot)}"
                                                    title="#{powerSlot.description}#{powerSlot.hostingSlot ? ' ('.concat(powerSlot.deviceTypeName).concat(')') : ''}" />
                                                <p:link rendered="#{powerSlot.hostingSlot and hierarchiesController.linkToNaming(powerSlot)}" target="_blank" 
                                                        href="#{hierarchiesController.namingRedirectionUrl}#{powerSlot.name}" title="Open in Naming Service">
                                                    <h:outputText value="" rendered="#{powerSlot.hostingSlot}" 
                                                        style="display:inline-block; vertical-align:bottom !important; margin-left: 1ex;"
                                                        styleClass="ui-icon ui-icon-extlink"/>
                                                </p:link>    
                                            </p:column>
                                        </p:treeTable>
	                               </div>
                                </p:tab>
                                <p:tab id="CONNECTS" title="Connects" rendered="#{hierarchiesController.cableDBStatus}">
                                    <p:inputText id="filterConnectsTree" value="#{hierarchiesController.filterConnectsTree}"
                                                 style="box-sizing: border-box; width:100%">
                                        <p:ajax event="keyup" delay="1000" listener="#{hierarchiesController.filterConnectsTree()}"
                                         update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton
                                                        :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                                                        :hierarchies:installationDetails :hierarchies:slotAttributes
                                                        :hierarchies:addRelationship :hierarchies:hierarchyTabs:connectsTree                                                        
                                                        :hierarchies:clipboardOperations"/>                                                 
                                    </p:inputText>                                
                                    <div style="height: calc(100% - 2em)">
                                        <p:treeTable id="connectsTree" value="#{hierarchiesController.connectsRoot}" var="connectsSlot"
                                                 selectionMode="multiple" selection="#{hierarchiesController.selectedConnectsNodes}"
                                                 scrollable="true" scrollWidth="100%" scrollHeight="100%" rowStyleClass="treeRows"
                                                 widgetVar="connectsWidget">
                                            <p:ajax event="select" listener="#{hierarchiesController.onNodeSelect}"
                                                    update=":hierarchies:relationsTable :hierarchies:installationDetails
                                                            :hierarchies:slotAttributes :hierarchies:addRelationship"
                                                    oncomplete="hierarchiesResizeAll();" />
                                            <p:ajax event="unselect" listener="#{hierarchiesController.onNodeUnselect}"
                                                    update=":hierarchies:relationsTable :hierarchies:installationDetails
                                                            :hierarchies:slotAttributes :hierarchies:addRelationship"
                                                    oncomplete="hierarchiesResizeAll();" />
                                            <p:ajax event="expand" listener="#{hierarchiesController.onConnectsExpand}" />
    
                                            <p:column id="connectsName" headerText="Name">
                                                <h:outputText value="" rendered="#{connectsSlot.hostingSlot}"
                                                    style="display:inline-block; vertical-align:bottom !important"
                                                    styleClass="ui-icon ui-icon-wrench" />
                                                <h:outputText value="" rendered="#{!connectsSlot.hostingSlot}"
                                                    style="display:inline-block; vertical-align:bottom !important"
                                                    styleClass="ui-icon ui-icon-folder-collapsed" />
                                                <h:outputText value="#{connectsSlot.name}" styleClass="#{hierarchiesController.calcNameClass(connectsSlot)}"
                                                    title="#{connectsSlot.description}#{connectsSlot.hostingSlot ? ' ('.concat(connectsSlot.deviceTypeName).concat(')') : ''}" />                                                
                                                <p:commandLink rendered="#{connectsSlot.hostingSlot 
                                                        and (not empty connectsSlot.cableNumber
                                                        or hierarchiesController.linkToNaming(connectsSlot))}" update=":linksForm" oncomplete="PF('linksDlg').show()">
                                                    <h:outputText value="" rendered="#{connectsSlot.hostingSlot}" 
                                                        style="display:inline-block; vertical-align:bottom !important; margin-left: 1ex;"
                                                        styleClass="ui-icon ui-icon-extlink"/>
                                                    <f:setPropertyActionListener target="#{hierarchiesController.linkSlot}" value="#{connectsSlot}"/>
                                                </p:commandLink>
                                            </p:column>
                                        </p:treeTable>
                                    </div>
                                </p:tab>
                            </p:tabView>
                        </div>
                            <p:menuButton value="+/-" id="expandColapseOp" style="float: right; margin-top: 1em;">
                                <p:menuitem value="Expand" id="expandButton" icon="ui-icon-plus"
                                    title="Expand selected items"
                                    action="#{hierarchiesController.expandTreeNodes}" oncomplete="hierarchiesResizeAll();"                                   
                                    update=":hierarchies:hierarchyTabs:tree :hierarchies:hierarchyTabs:controlsTree :hierarchies:hierarchyTabs:powersTree
                                       :hierarchies:hierarchyTabs:connectsTree" />
                                <p:menuitem value="Collapse" id="collapseButton" icon="ui-icon-minus"
                                    title="Collapse selected items"
                                    action="#{hierarchiesController.collapseTreeNodes}" oncomplete="hierarchiesResizeAll();"                                    
                                    update=":hierarchies:hierarchyTabs:tree :hierarchies:hierarchyTabs:controlsTree :hierarchies:hierarchyTabs:powersTree
                                       :hierarchies:hierarchyTabs:connectsTree" />                            
                            </p:menuButton>
                            <p:menuButton value="C/P" id="clipboardOperations" style="float: right; margin: 1em 1ex 0 0;"
                                disabled="#{not hierarchiesController.includesActive}">
                                <p:menuitem value="Copy" id="copyButton" icon="ui-icon-copy"
                                    title="Put selected items to clipboard for copying"
                                    action="#{hierarchiesController.copyTreeNodes}" oncomplete="hierarchiesResizeAll();"
                                    disabled="#{not hierarchiesController.includesActive or
                                                    empty hierarchiesController.selectedIncludesNodes}"
                                    update=":hierarchies:hierarchyTabs:tree :hierarchies:clipboardOperations" />
                                <p:menuitem value="Cut" id="cutButton" icon="ui-icon-scissors"
                                    title="Put selected items to clipboard for moving"
                                    action="#{hierarchiesController.cutTreeNodes}" oncomplete="hierarchiesResizeAll();"
                                    disabled="#{not hierarchiesController.includesActive or
                                                    empty hierarchiesController.selectedIncludesNodes}"
                                    update=":hierarchies:hierarchyTabs:tree :hierarchies:clipboardOperations" />
                                <p:menuitem value="Paste" id="pasteButton" icon="ui-icon-clipboard"
                                    title="Paste into the selected parent" oncomplete="PF('pasteSlots').show();"
                                    disabled="#{not hierarchiesController.includesActive
                                                    or hierarchiesController.multipleNodesSelected
                                                    or hierarchiesController.clipboardEmpty}"
                                    action="#{hierarchiesController.checkPasteAction}"
                                    update=":pasteSlotsForm:pasteSlots" />
                            </p:menuButton>
                            <p:commandButton id="deleteButton" icon="ui-icon-trash" value="Delete" title="Delete"
                                style="float: right; margin: 1em 1ex 0 0;" oncomplete="PF('deleteSlots').show();"
                                disabled="#{not hierarchiesController.includesActive
                                                or empty hierarchiesController.selectedIncludesNodes}"
                                update=":deleteSlotsForm" actionListener="#{hierarchiesController.prepareDeletePopup()}" />
                            <p:commandButton id="downButton" icon="ui-icon-arrowthick-1-s" value="Down" title="Move down"
                                style="float: right; margin: 1em 1ex 0 0;"
                                oncomplete="hierarchiesResizeAll(); scrollSelectedIntoView(PF('hierarchyWidget'));"
                                update=":hierarchies:hierarchyTabs:tree :hierarchies:downButton :hierarchies:upButton"
                                disabled="#{not hierarchiesController.singleNodeSelected
                                                or not hierarchiesController.includesActive
                                                or not empty hierarchiesController.filterContainsTree
                                                or hierarchiesController.singleSelectedSlotView.last}"
                                actionListener="#{hierarchiesController.moveSlotDown()}" />
                            <p:commandButton id="upButton" icon="ui-icon-arrowthick-1-n" value="Up" title="Move up"
                                style="float: right; margin: 1em 1ex 0 0;"
                                oncomplete="hierarchiesResizeAll(); scrollSelectedIntoView(PF('hierarchyWidget'));"
                                update=":hierarchies:hierarchyTabs:tree :hierarchies:upButton :hierarchies:downButton"
                                disabled="#{not hierarchiesController.singleNodeSelected
                                                or not hierarchiesController.includesActive
                                                or not empty hierarchiesController.filterContainsTree
                                                or hierarchiesController.singleSelectedSlotView.first}"
                                actionListener="#{hierarchiesController.moveSlotUp()}" />
                            <p:commandButton id="editButton" icon="ui-icon-pencil" value="Edit" title="Edit"
                                style="float: right; margin: 1em 1ex 0 0;" update=":editSlotForm:editSlotDialog"
                                disabled="#{not hierarchiesController.singleNodeSelected or not hierarchiesController.includesActive}"
                                oncomplete="PF('editSlotDialog').show();"
                                actionListener="#{hierarchiesController.prepareEditPopup()}" />

                            <p:menuButton id="addButton" value="Add" style="float: right; margin: 1em 1ex 0 0;"
                                    disabled="#{not hierarchiesController.includesActive
                                                    or hierarchiesController.multipleNodesSelected}">
                                <p:menuitem value="Container" oncomplete="PF('addSlotDialog').show();"
                                        actionListener="#{hierarchiesController.prepareContainerAddPopup}"
                                        update=":addSlotForm"
                                        disabled="#{hierarchiesController.multipleNodesSelected
                                                        or hierarchiesController.selectedNodeSlot.hostingSlot}" />
                                <p:menuitem value="Installation slot" oncomplete="PF('addSlotDialog').show();"
                                        actionListener="#{hierarchiesController.prepareInstallationSlotPopup}"
                                        update=":addSlotForm" disabled="#{not hierarchiesController.singleNodeSelected}" />
                            </p:menuButton>
                        </p:fieldset>
                    </p:column>
                    <p:column id="attributesColumn" styleClass="alignTop" >
                        <p:fieldset id="slotAttributes" legend="Properties" style="box-sizing: border-box; height: calc(33.33vh - 4em)">
                            <div style="height: calc(100% - 3em)">
                                <p:dataTable id="attributesTable" class="hierarchies-attributes-cell" var="attribute" 
                                        emptyMessage="No records found." value="#{hierarchiesController.attributes}" 
                                        scrollable="true" scrollWidth="100%" scrollHeight="100%"
                                        selection="#{hierarchiesController.selectedAttributes}" selectionMode="multiple"
                                        filteredValue="#{hierarchiesController.filteredAttributes}" rowKey="#{attribute.id}"
                                        widgetVar="attributesWidget">
                                    <p:ajax event="rowSelect" update=":hierarchies:deleteAttrButton :hierarchies:editAttrButton" />
                                    <p:ajax event="rowUnselect" update=":hierarchies:deleteAttrButton :hierarchies:editAttrButton" />                                
                    
                                    <p:column headerText="Container/Slot" sortBy="#{attribute.parent}" filterBy="#{attribute.parent}"
                                            filterMatchMode="contains" >
                                        <h:outputText value="#{attribute.parent}" />
                                    </p:column>
    
                                    <p:column headerText="Name" sortBy="#{attribute.name}" filterBy="#{attribute.name}"
                                            filterMatchMode="contains">
                                        <h:outputText value="#{attribute.name}" />
                                    </p:column>
    
                                    <p:column headerText="Value" sortBy="#{attribute.value}"
                                            filterBy="#{attribute.value}" filterMatchMode="contains">
                                        <h:outputLink rendered="#{attribute.hasURL}" target="_blank" value="#{attribute.value}" title="Go to URL">
                                            <h:outputText value="#{attribute.value}" style="text-decoration: underline;" />
                                        </h:outputLink>
                                        <h:outputText value="#{!empty attribute.value ? attribute.value : '-'}" rendered="#{not attribute.hasURL}" />
                                        <p:commandLink ajax="false" title="Download" rendered="#{attribute.hasFile}" style="margin-left: 1ex;">
                                            <h:outputText styleClass="ui-icon ui-icon-arrowthick-1-s" style="display: inline-block !important; margin-right: 6px;" />
                                            <f:setPropertyActionListener value="#{attribute}" target="#{hierarchiesController.downloadAttribute}" />
                                            <p:fileDownload value="#{hierarchiesController.downloadFile}" />
                                        </p:commandLink>
                                    </p:column>
    
                                    <p:column headerText="Unit" sortBy="#{attribute.unit.name}" filterBy="#{attribute.unit.name}"
                                            filterMatchMode="contains">
                                        <h:outputLink rendered="#{!empty attribute.unit}"
                                                value="#{request.contextPath}/units.xhtml?id=#{attribute.unit.id}">
                                            <h:outputText value="#{attribute.unit.name}" style="text-decoration: underline;" />
                                        </h:outputLink>
                                        <h:outputText value="-" rendered="#{empty attribute.unit}" />
                                    </p:column>
    
                                    <p:column headerText="Kind" sortBy="#{attribute.kind.toString()}"
                                            filterBy="#{attribute.kind}" filterMatchMode="exact"
                                            filterOptions="#{hierarchiesController.attributeKinds}">
                                        <h:outputText value="#{attribute.kind.toString()}" />
                                    </p:column>
    
                                    <p:column headerText="Data type" sortBy="#{attribute.type.name}"
                                            filterBy="#{attribute.type.name}" filterMatchMode="contains">
                                        <h:outputText value="#{attribute.type.name}" />
                                    </p:column>
                                </p:dataTable>
                            </div>
                            <p:commandButton id="deleteAttrButton" value="Delete" icon="ui-icon-trash"
                                style="float: right; margin-top: 1em;" oncomplete="PF('deleteAttribute').show();"
                                disabled="#{!hierarchiesController.canDeleteAttributes()}" />
                            <p:commandButton id="editAttrButton" value="Edit" icon="ui-icon-pencil"
                                action="#{hierarchiesController.prepareModifyAttributePopup}"
                                style="float: right; margin: 1em 1ex 0 0;" update=":modifyPropertyValueForm :modifyArtifactForm"
                                disabled="#{!hierarchiesController.canEditAttribute()}" />
                            <p:menuButton id="addAttrButton" value="Add" style="margin: 1em 1ex 0 0; float: right;"
                                    disabled="#{not hierarchiesController.singleNodeSelected}">
                                <p:menuitem value="Container property" oncomplete="PF('addPropertyValue').show();"
                                        actionListener="#{hierarchiesController.prepareForPropertyValueAdd}"
                                        disabled="#{hierarchiesController.selectedNodeSlot.hostingSlot}"
                                        update=":addPropertyValueForm:addPropertyValue" />
                                <p:menuitem value="Tag" oncomplete="PF('containerTag').show();" update=":containerTagForm"
                                        actionListener="#{hierarchiesController.prepareForTagAdd}" />
                                <p:menuitem value="Artifact" oncomplete="PF('addArtifact').show();"
                                        actionListener="#{hierarchiesController.prepareForArtifactAdd}"
                                        update=":addArtifactForm:addArtifact" />
                            </p:menuButton>
                        </p:fieldset>
                        <p:spacer height="20" />
                    </p:column>
                </p:row>
                <p:row>
                    <p:column id="relationsColumn" styleClass="alignTop">
                        <p:fieldset id="relationsTable" legend="Relationships" style="box-sizing: border-box; height: calc(33.33vh - 4em)">
                            <div style="height: calc(100% - 3em)">
                                <p:dataTable value="#{hierarchiesController.relationships}" id="relationshipTable"
                                        var="relationship" emptyMessage="No records found."
                                        scrollable="true" scrollWidth="100%" scrollHeight="100%" 
                                        class="hierarchies-attributes-cell"
                                        filteredValue="#{hierarchiesController.filteredRelationships}"
                                        selectionMode="multiple" rowKey="#{relationship.id}"
                                        selection="#{hierarchiesController.selectedRelationships}"
                                        widgetVar="relationshipsWidget">
                                    <p:ajax event="rowSelect" update=":hierarchies:deleteRelationship" />
                                    <p:ajax event="rowUnselect" update=":hierarchies:deleteRelationship" />                                
                                    
                                    <p:column headerText="Source" sortBy="#{relationship.sourceSlotName}" 
                                            filterBy="#{relationship.sourceSlotName}" filterMatchMode="contains">
                                        <h:outputText value="#{relationship.sourceSlotName}" />
                                    </p:column>
    
                                    <p:column headerText="Relationship" sortBy="#{relationship.relationshipName}"
                                            filterOptions="#{hierarchiesController.relationshipTypes}"
                                            filterBy="#{relationship.relationshipName}" filterMatchMode="exact">
                                        <h:outputText value="#{relationship.relationshipName}" />
                                    </p:column>
    
                                    <p:column headerText="Target" sortBy="#{relationship.targetSlotName}"
                                            filterBy="#{relationship.targetSlotName}" filterMatchMode="contains">
                                        <p:commandLink action="#{hierarchiesController.selectNode(relationship.slot)}"
                                                rendered="#{hierarchiesController.includesActive}"
                                                update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton
                                                    :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                                                    :hierarchies:installationDetails :hierarchies:slotAttributes
                                                    :hierarchies:addRelationship :hierarchies:hierarchyTabs:tree"
                                                oncomplete="hierarchiesResizeAll();scrollSelectedIntoView(getVisibleTree());
                                                PF('relationshipsWidget').clearFilters();PF('attributesWidget').clearFilters();">
                                            <h:outputText value="#{relationship.targetSlotName}"
                                                style="text-decoration: underline;" />
                                        </p:commandLink>
                                        <h:outputText value="#{relationship.targetSlotName}"
                                            rendered="#{not hierarchiesController.includesActive}" />
                                    </p:column>
                                </p:dataTable>
                            </div>

                            <p:commandButton id="deleteRelationship" value="Delete" icon="ui-icon-trash"
                                style="margin-top: 1em; float: right;" disabled="#{empty hierarchiesController.selectedRelationships}"
                                oncomplete="PF('deleteRelationship').show();" />
                            <p:commandButton value="Add" oncomplete="PF('addSlotRelationship').show()" id="addRelationship"
                                icon="ui-icon-plus" disabled="#{not hierarchiesController.singleNodeSelected}"
                                style="margin: 1em 1ex 0 0; float: right;" update=":addSlotRelationshipForm:addSlotRelationship"
                                actionListener="#{hierarchiesController.prepareAddRelationshipPopup}" />
                        </p:fieldset>
                        <p:spacer height="20" />
                    </p:column>
                </p:row>
                <p:row>
                    <p:column id="installationColumn" styleClass="alignTop">
                        <p:fieldset id="installationDetails" legend="Installation"  style="box-sizing: border-box; height: calc(33.33vh - 4em)">
                            <div style="height: calc(100% - 3em)">
                                <p:dataTable id="installationTable" value="#{hierarchiesController.installationRecords}"
                                        var="installationRecord" widgetVar="installationWidget"
                                        selectionMode="multiple" selection="#{hierarchiesController.selectedInstallationViews}"
                                        emptyMessage="No records found." rowKey="#{installationRecord.slotName}"
                                        filteredValue="#{hierarchiesController.filteredInstallationRecords}"
                                        scrollable="true" scrollWidth="100%" scrollHeight="100%" class="hierarchies-attributes-cell">
    
                                    <p:ajax event="rowSelect" update=":hierarchies:installDeviceBtn :hierarchies:uninstallDeviceBtn" />
                                    <p:ajax event="rowUnselect" update=":hierarchies:installDeviceBtn :hierarchies:uninstallDeviceBtn" />                                
                                    
                                    <p:column headerText="Slot" sortBy="#{installationRecord.slotName}" 
                                            filterBy="#{installationRecord.slotName}" filterMatchMode="contains">
                                        <h:outputText value="#{installationRecord.slotName}" />
                                    </p:column>
                                    <p:column headerText="Inventory ID" 
                                            sortBy="#{installationRecord.deviceInventoryId}" 
                                            filterBy="#{installationRecord.deviceInventoryId}">
                                        <h:link outcome="deviceManager" value="#{installationRecord.deviceInventoryId}"
                                                class="link" rendered="#{installationRecord.deviceInstalled}">
                                            <f:param name="id" value="#{installationRecord.installationRecord.device.id}" />
                                        </h:link>
                                        <h:outputText value="-" rendered="#{not installationRecord.deviceInstalled}" />
                                    </p:column>
                                    <p:column headerText="Timestamp" sortBy="#{installationRecord.installDate}"
                                            filterBy="#{installationRecord.installDate}" filterMatchMode="contains">
                                        <h:outputText value="#{installationRecord.installDate}"
                                                rendered="#{installationRecord.deviceInstalled}">
                                            <f:convertDateTime pattern="#{msgs.timestampFormat}" />
                                        </h:outputText>
                                        <h:outputText value="-"
                                                rendered="#{not installationRecord.deviceInstalled}" />
                                    </p:column>
                                </p:dataTable>
                            </div>
                            <p:commandButton title="Uninstall selected device" label="Uninstall" value="Uninstall"
                                type="button" onclick="PF('uninstallConfirm').show();" id="uninstallDeviceBtn"
                                style="margin-top: 1em; float: right;" update=":hierarchies:installationDetails"
                                disabled="#{!hierarchiesController.canUninstall()}" />
                            <p:commandButton title="Install device to the selected slot" id="installDeviceBtn"
                                    value="Install" ajax="true"
                                    actionListener="#{hierarchiesController.prepareUninstalledDevices}"
                                    style="margin: 1em 1ex 0 0; float: right;" update=":hierarchies:installationDetails :installDeviceForm :installDeviceForm:installDevice"
                                    disabled="#{!hierarchiesController.canInstall()}"
                                    oncomplete="PF('installDevice').show();" />                            
                        </p:fieldset>
                    </p:column>
                </p:row>
            </p:panelGrid>
        </h:form>

        <ui:include src="/resources/dialogs/install-device.xhtml">
            <ui:param name="formId" value="installDeviceForm" />
            <ui:param name="dialogTitle" value="Select Device" />
            <ui:param name="widgetName" value="installDevice" />
            <ui:param name="slot" value="#{hierarchiesController.selectedInstallationViews.get(0).slot}" />
            <ui:param name="componentToUpdate"
                value=":hierarchies:slotAttributes :hierarchies:relationsTable :hierarchies:installationDetails" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-slots-confirmation.xhtml" >
            <ui:param name="formId" value="deleteSlotsForm" />
            <ui:param name="dialogTitle" value="#{hierarchiesController.numberOfSlotsToDelete gt 1
                                                        ? 'Delete Containers/Slots' 
                                                        : 'Delete Container/Slot'}" />
            <ui:param name="widgetName" value="deleteSlots" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="onSlotsDelete" />
            <ui:param name="formsToUpdate" value=":hierarchies:hierarchyTabs:tree :hierarchies:deleteButton
                    :hierarchies:slotAttributes :hierarchies:relationsTable :hierarchies:installationDetails
                    :hierarchies:downButton :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton
                    :hierarchies:clipboardOperations" />
            <ui:param name="resizeContent" value="hierarchiesResizeAll();" />
            <ui:param name="entityType" value="#{hierarchiesController.numberOfSlotsToDelete gt 1
                                                        ? 'the following slots:' : 'selected slot?'}" />
            <ui:param name="isTableDisplayed" value="#{(hierarchiesController.numberOfSlotsToDelete gt 1)}" />
            <ui:param name="slotsToDelete" value="#{hierarchiesController.slotsToDelete}" />
            <ui:param name="filteredSlotsToDelete" value="#{hierarchiesController.filteredSlotsToDelete}" />
            <ui:param name="resetFilter"
                value="PF('attributesWidget').clearFilters(); PF('relationshipsWidget').clearFilters(); PF('installationWidget').clearFilters();" />
        </ui:include>

        <ui:include src="/resources/dialogs/paste-slots-confirmation.xhtml" >
            <ui:param name="formId" value="pasteSlotsForm" />
            <ui:param name="widgetName" value="pasteSlots" />
            <ui:param name="formsToUpdate" value=":hierarchies:cutButton :hierarchies:pasteButton
                    :hierarchies:hierarchyTabs:tree" />
            <ui:param name="closeDialogActions" value="hierarchiesResizeAll();" />
        </ui:include>

        <ui:include src="/resources/dialogs/add-or-modify-slot.xhtml">
            <ui:param name="formId" value="editSlotForm" />
            <ui:param name="widgetName" value="editSlotDialog" />
            <ui:param name="dialogTitle" value="Edit #{hierarchiesController.selectedNodeSlot.hostingSlot
                                                    ? 'Installation Slot' : 'Container'}" />
            <ui:param name="submitHandler" value="onSlotModify" />
        </ui:include>

        <ui:include src="/resources/dialogs/add-or-modify-slot.xhtml">
            <ui:param name="formId" value="addSlotForm" />
            <ui:param name="widgetName" value="addSlotDialog" />
            <ui:param name="dialogTitle" value="Add #{hierarchiesController.installationSlot
                                                    ? 'Installation Slot' : 'Container'}" />
            <ui:param name="submitHandler" value="onSlotAdd" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-multi-confirmation.xhtml">
            <ui:param name="formId" value="deleteAttributeForm" />
            <ui:param name="dialogTitle" value="Delete Properties" />
            <ui:param name="widgetName" value="deleteAttribute" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="deleteAttributes" />
            <ui:param name="formToUpdate" value=":hierarchies:slotAttributes" />
            <ui:param name="entityType" value="selected attribute" />
            <ui:param name="closeDialogActions" value="PF('attributesWidget').clearFilters();" />
            <ui:param name="entityType" value="properties" />
            <ui:param name="entityName" value="Property" />            
            <ui:param name="deleteList" value="#{hierarchiesController.selectedAttributes}" />          
        </ui:include>

        <ui:include src="/resources/dialogs/property-value.xhtml">
            <ui:param name="formId" value="modifyPropertyValueForm" />
            <ui:param name="dialogTitle" value="Edit Property" />
            <ui:param name="widgetName" value="modifyPropertyValue" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="modifyPropertyValue" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
            <ui:param name="resetFilter" value="PF('attributesWidget').clearFilters();" />
        </ui:include>

        <ui:include src="/resources/dialogs/property-value.xhtml">
            <ui:param name="formId" value="addPropertyValueForm" />
            <ui:param name="dialogTitle" value="Add Property" />
            <ui:param name="widgetName" value="addPropertyValue" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="addNewPropertyValue" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
            <ui:param name="resetFilter" value="PF('attributesWidget').clearFilters();" />
        </ui:include>

        <ui:include src="/resources/dialogs/tag.xhtml" >
            <ui:param name="formId" value="containerTagForm" />
            <ui:param name="dialogTitle" value="Add Tag" />
            <ui:param name="widgetName" value="containerTag" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="addNewTag" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
            <ui:param name="resetFilter" value="PF('attributesWidget').clearFilters();" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml" >
            <ui:param name="formId" value="addArtifactForm" />
            <ui:param name="dialogTitle" value="Add Artifact" />
            <ui:param name="widgetName" value="addArtifact" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="addNewArtifact" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
            <ui:param name="resetFilter" value="PF('attributesWidget').clearFilters();" />
        </ui:include>

        <ui:include src="/resources/dialogs/artifact.xhtml">
            <ui:param name="formId" value="modifyArtifactForm" />
            <ui:param name="dialogTitle" value="Edit Artifact" />
            <ui:param name="widgetName" value="modifyArtifact" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="modifyArtifact" />
            <ui:param name="componentToUpdate" value=":hierarchies:slotAttributes" />
            <ui:param name="resetFilter" value="PF('attributesWidget').clearFilters();" />
        </ui:include>

        <ui:include src="/resources/dialogs/delete-multi-confirmation.xhtml">
            <ui:param name="formId" value="deleteRelationshipForm" />
            <ui:param name="dialogTitle" value="Delete Relationships" />
            <ui:param name="widgetName" value="deleteRelationship" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="onRelationshipDelete" />
            <ui:param name="formToUpdate" value=":hierarchies:relationshipTable :hierarchies:deleteRelationship
                    :hierarchies:hierarchyTabs:tree" />
            <ui:param name="entityType" value="selected relationships" />
            <ui:param name="entityName" value="Relationship" />
            <ui:param name="entityProperty" value="targetSlotName" />
            <ui:param name="closeDialogActions" value="PF('relationshipsWidget').clearFilters();" />
            <ui:param name="deleteList" value="#{hierarchiesController.selectedRelationships}" />                      
        </ui:include>        
        <ui:include src="/resources/dialogs/delete-multi-confirmation.xhtml">
            <ui:param name="formId" value="uninstallationForm" />
            <ui:param name="dialogTitle" value="Uninstall devices" />
            <ui:param name="widgetName" value="uninstallConfirm" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="message" value="Are you sure you want to uninstall selected devices?"/>
            <ui:param name="submitHandler" value="uninstallDevice" />
            <ui:param name="formToUpdate" value="hierarchies:installationDetails" />            
            <ui:param name="entityName" value="Device" />
            <ui:param name="entityProperty" value="deviceInventoryId" />
            <ui:param name="closeDialogActions" value="hierarchiesResizeAll();" />
            <ui:param name="deleteList" value="#{hierarchiesController.selectedInstallationViews}" />                      
        </ui:include>    
        <ui:include src="/resources/dialogs/cannot-delete-relationship.xhtml" />
        <ui:include src="/resources/dialogs/slot-pair-loop-notification.xhtml" />
        <ui:include src="/resources/dialogs/add-relationship.xhtml" />        
        <ui:include src="/resources/dialogs/cannot-find-slot.xhtml" />
        <ui:include src="/resources/dialogs/linkdialog.xhtml" />
        <script type="text/javascript">
            //<![CDATA[
            jQuery(window).resize(function() {
                hierarchiesResizeAll();
                scrollSelectedIntoView(PF('hierarchyWidget'));
            });

            jQuery(document).ready(function() {
                hierarchiesResizeAll();
                scrollSelectedIntoView(PF('hierarchyWidget'));
            });
            // PrimeFaces Shift-select workaround. Event is triggered on the last node. This is not a propert solution!
            PrimeFaces.widget.TreeTable.prototype.selectNodesInRange = function(node) {
                if (this.cursorNode) {
                    this.unselectAllNodes();

                    var currentNodeIndex = node.index(),
                    cursorNodeIndex = this.cursorNode.index(),
                    startIndex = (currentNodeIndex > cursorNodeIndex) ? cursorNodeIndex : currentNodeIndex,
                    endIndex = (currentNodeIndex > cursorNodeIndex) ? (currentNodeIndex + 1) : (cursorNodeIndex + 1),
                    nodes = this.tbody.children();

                    for (var i = startIndex ; i < endIndex; i++) {
                        this.selectNode(nodes.eq(i), (i != (endIndex - 1))); // fire event for the last node
                    }
                } else {
                    this.selectNode(node);
                }
            };
            // ]]>
        </script>
    </ui:define>
</ui:composition>