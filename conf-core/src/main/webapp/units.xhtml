<ui:composition template="/template/template.xhtml" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui">

    <ui:define name="content">
        <h:form id="unitsForm">
            <script type="text/javascript">
                // <![CDATA[
                function selectUnitInTable(globalIndex) {
                    // selectUnitInTable() only works on page load, so it can be used for navigating to 
                    //     an unit form another screen. 
                    var devicesTable = PF('unitsTableVar');
                    if (devicesTable.getPaginator().cfg.rowCount < 1) return;
                    
                    var rowsPerPage = devicesTable.getPaginator().cfg.rows;
                    var pageNumber = Math.trunc(globalIndex / rowsPerPage);
                    ccdb_tableSelectedIndex = globalIndex % rowsPerPage;
                    if (pageNumber >= 0) {
                        devicesTable.unselectAllRows();
                        if (pageNumber == devicesTable.getPaginator().getCurrentPage()) {
                            devicesTable.selectRow(ccdb_tableSelectedIndex);
                            ccdb_tableSelectedIndex = -1;
                        } else {
                            // after page change 'onTablePageSwitchAction()' will be called by the framework
                            devicesTable.getPaginator().setPage(pageNumber);
                        }
                    }
                }
                var ccdb_tableSelectedIndex = -1;
                function onTablePageSwitchAction() {
                    if (ccdb_tableSelectedIndex > -1) {
                        PF('unitsTableVar').selectRow(ccdb_tableSelectedIndex);
                        ccdb_tableSelectedIndex = -1;
                    }
                }
                // ]]>
            </script>
            <p:dataTable widgetVar="unitsTableVar" var="unit" id="unitsTable" value="#{unitManager.unitViews}" 
                    selection="#{unitManager.selectedUnit}" selectionMode="single" rowKey="#{unit.unit.id}" 
                    resizableColumns="true" style="table-layout: fixed; word-wrap: break-word;" 
                    filteredValue="#{unitManager.filteredUnits}" rows="15" paginator="true" 
                    paginatorPosition="bottom">
                <p:ajax event="filter" ignoreAutoUpdate="true" />
                <p:ajax event="rowSelect" update=":unitsForm:deleteButton :unitsForm:editButton" />
                <p:ajax event="rowUnselect" update=":unitsForm:deleteButton :unitsForm:editButton" />
                <p:ajax event="page" oncomplete="onTablePageSwitchAction();" />

                <p:column headerText="Name" sortBy="#{unit.name.toUpperCase()}" filterBy="#{unit.name}" width="20%" 
                        filterMatchMode="contains">
                    <h:outputText value="#{unit.name}" />
                </p:column>

                <p:column headerText="Description" sortBy="#{unit.description}" filterBy="#{unit.description}" 
                        width="50%" filterStyle="width: 20em;" filterMatchMode="contains">
                    <h:outputText value="#{unit.description}" />
                </p:column>

                <p:column headerText="Symbol" sortBy="#{unit.symbol}" width="10%" filterBy="#{unit.symbol}" 
                        filterStyle="width: 90%;">
                    <h:outputText value="#{unit.symbol}" />
                </p:column>

                <p:column headerText="Quantity" filterBy="#{unit.quantity}" sortBy="#{unit.quantity}" width="10%" 
                        filterStyle="width: 90%;">
                    <h:outputText value="#{unit.quantity}" />
                </p:column>
            </p:dataTable>

            <p:commandButton id="exportButton" icon="ui-icon-disk" value="Export" title="Export" 
                style="float: right; margin-top: 1em;" oncomplete="PF('exportUnits').show();" 
                disabled="#{empty unitManager.unitViews}" update=":exportUnitsForm:exportUnits" 
                actionListener="#{unitManager.simpleTableDialog.prepareTableExportPopup}" />
            <p:commandButton id="deleteButton" icon="ui-icon-trash" value="Delete" title="Delete" 
                style="float: right; margin: 1em 1ex 0 0;" oncomplete="PF('deleteUnit').show();" 
                disabled="#{empty unitManager.selectedUnit or unitManager.selectedUnitInUse}" />
            <p:commandButton id="editButton" icon="ui-icon-pencil" value="Edit" title="Edit" 
                style="float: right; margin: 1em 1ex 0 0;" update=":modifyUnitForm:modifyUnit" 
                disabled="#{empty unitManager.selectedUnit}" oncomplete="PF('modifyUnit').show();" 
                actionListener="#{unitManager.prepareModifyPopup}" />
            <p:commandButton ajax="true" actionListener="#{unitManager.prepareAddPopup}" value="Add" 
                update=":addUnitForm" title="Add unit" icon="ui-icon-plus"
                oncomplete="PF('addUnit').show()" style="float: right; margin: 1em 1ex 0 0;" />
        </h:form>

        <ui:include src="/resources/dialogs/delete-confirmation.xhtml" >
            <ui:param name="formId" value="deleteUnitForm" />
            <ui:param name="dialogTitle" value="Delete unit" />
            <ui:param name="widgetName" value="deleteUnit" />
            <ui:param name="controller" value="#{unitManager}" />
            <ui:param name="submitHandler" value="onDelete" />
            <ui:param name="formToUpdate" value=":unitsForm:unitsTable :unitsForm:deleteButton :unitsForm:editButton 
                                                :unitsForm:exportButton" />
            <ui:param name="resetFilter" value="PF('unitsTableVar').filter();" />               
            <ui:param name="entityType" value="this unit" />
        </ui:include>

        <ui:include src="/resources/dialogs/add-or-modify-unit.xhtml">
            <ui:param name="formId" value="modifyUnitForm" />
            <ui:param name="dialogTitle" value="Modify unit" />
            <ui:param name="widgetName" value="modifyUnit" />
            <ui:param name="submitHandler" value="onModify" />
        </ui:include>

        <ui:include src="/resources/dialogs/add-or-modify-unit.xhtml">
            <ui:param name="formId" value="addUnitForm" />
            <ui:param name="dialogTitle" value="Add unit" />
            <ui:param name="widgetName" value="addUnit" />
            <ui:param name="submitHandler" value="onAdd" />
        </ui:include>

        <ui:include src="/resources/dialogs/export-table.xhtml">
            <ui:param name="formId" value="exportUnitsForm" />
            <ui:param name="widgetName" value="exportUnits" />
            <ui:param name="dialogTitle" value="Export units table" />
            <ui:param name="fileFormatSelection" value="#{unitManager.simpleTableDialog.fileFormat}" />
            <ui:param name="includeHeader" value="#{unitManager.simpleTableDialog.includeHeaderRow}" />
            <ui:param name="tableFile" value="#{unitManager.simpleTableDialog.exportedTable}" />
        </ui:include>
    </ui:define>
</ui:composition>