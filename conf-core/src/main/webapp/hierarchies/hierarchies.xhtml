<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    template="/template/template.xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html">

    <ui:define name="content">
        <h:form id="hierarchies">
            <p:growl showDetail="true" globalOnly="true" autoUpdate="true" />
            <p:panelGrid id="hierarchiesContainer" style="width: 100%;" styleClass="noBorders">
                <p:row>
                    <p:column rowspan="4" id="treeColumn">
                        <p:treeTable id="tree" value="#{hierarchiesController.rootNode}" var="installationSlot" 
                                selectionMode="single" selection="#{hierarchiesController.selectedNode}" 
                                scrollable="true" scrollWidth="auto" style="width: 300px;" rowStyleClass="treeRows" 
                                widgetVar="hierarchyWidget">
                            <p:ajax event="select" listener="#{hierarchiesController.initSelectedItemLists()}"
                                update=":hierarchies:attributesTable :hierarchies:relationsTable :hierarchies:installationDetails :hierarchies:slotAttributesTitle" 
                                oncomplete="resizeEmptyColumnInHierarchies();" />
                            <p:ajax event="unselect" listener="#{hierarchiesController.clearAttributeList()}"
                                update=":hierarchies:attributesTable :hierarchies:relationsTable :hierarchies:installationDetails :hierarchies:slotAttributesTitle" 
                                oncomplete="resizeEmptyColumnInHierarchies();" />

                            <p:column id="name" headerText="Name">
                                <h:outputText value="" rendered="#{installationSlot.isHostingSlot}" 
                                    style="display:inline-block; vertical-align:bottom !important"
                                    styleClass="ui-icon ui-icon-wrench" />
                                <h:outputText value="" rendered="#{!installationSlot.isHostingSlot}" 
                                    style="display:inline-block; vertical-align:bottom !important"
                                    styleClass="ui-icon ui-icon-folder-collapsed" />
                                <h:outputText value="#{installationSlot.name}" />
                            </p:column>
                        </p:treeTable>
                    </p:column>
                    <p:column styleClass="alignTop" >
                        <h3>
                            <h:panelGroup id="slotAttributesTitle">
                                <h:outputText rendered="#{hierarchiesController.selectedNodeSlot.hostingSlot}" 
                                    value="#{hierarchiesController.selectedNodeSlot.componentType.name} installation slot attributes" />
                                <h:outputText rendered="#{!hierarchiesController.selectedNodeSlot.hostingSlot}" 
                                    value="Container attributes" />
                            </h:panelGroup>
                        </h3>

                        <p:dataTable id="attributesTable" class="hierarchies-attributes-cell" emptyMessage="No element selected."
                                value="#{hierarchiesController.attributes}" var="attribute" scrollable="true"
                                style="width: 100%; overflow-y: hidden; max-height: 324px;" 
                                filteredValue="#{hierarchiesController.filteredAttributes}">
                            <p:column headerText="Name" sortBy="#{attribute.name}" filterBy="#{attribute.name}" 
                                    filterMatchMode="contains">
                                <h:outputText value="#{attribute.name}" />
                            </p:column>

                            <p:column headerText="Value" style="width: 400px;" sortBy="#{attribute.value}" 
                                    filterBy="#{attribute.value}" filterMatchMode="contains">
                                <h:outputText value="#{attribute.value}" />
                            </p:column>

                            <p:column headerText="Unit" sortBy="#{attribute.unit.name}" filterBy="#{attribute.unit.name}"
                                    filterMatchMode="contains">
                                <h:outputLink rendered="#{!empty attribute.unit}" 
                                        value="#{request.contextPath}/data-definitions/units/units-manager.xhtml?id=#{attribute.unit.id}">
                                    <h:outputText value="#{attribute.unit.name}" style="text-decoration: underline;" />
                                </h:outputLink>
                                <h:outputText value="-" rendered="#{empty attribute.unit}" />
                            </p:column>

                            <p:column headerText="Kind" sortBy="#{attribute.kind.toString()}" 
                                    filterBy="#{attribute.kind}" filterMatchMode="exact" 
                                    filterOptions="#{hierarchiesController.attributeKinds}">
                                <h:outputText value="#{attribute.kind.toString()}" />
                            </p:column>

                            <p:column headerText="Data type" sortBy="#{attribute.type.name}" 
                                    filterBy="#{attribute.type.name}" filterMatchMode="contains">
                                <h:outputText value="#{attribute.type.name}" />
                            </p:column>
                        </p:dataTable>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column styleClass="alignTop">
                        <h3 id="slotRelationshipsTitle">Slot relationships</h3>

                        <p:dataTable id="relationsTable" value="#{hierarchiesController.relationships}" 
                                style="width: 100%; overflow-y: hidden; max-height: 324px;" var="relationship" 
                                emptyMessage="No element selected." scrollable="true" class="hierarchies-attributes-cell" 
                                filteredValue="#{hierarchiesController.filteredRelationships}">
                            <p:column headerText="Relationship" sortBy="#{relationship.relationshipName}" 
                                    filterOptions="#{hierarchiesController.relationshipTypes}" 
                                    filterBy="#{relationship.relationshipName}" filterMatchMode="exact">
                                <h:outputText value="#{relationship.relationshipName}" />
                            </p:column>

                            <p:column headerText="Target" sortBy="#{relationship.targetSlotName}" 
                                    filterBy="#{relationship.targetSlotName}" filterMatchMode="contains">
                                <p:commandLink action="#{hierarchiesController.selectNode(relationship.slot.id)}" 
                                        update=":hierarchies" oncomplete="hierarchiesResizeAll();">
                                    <h:outputText value="#{relationship.targetSlotName}" 
                                        style="text-decoration: underline;" />
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column>
                        <h:panelGroup id="installationDetails" layout="block">
                            <p:panel styleClass="noBorders installation-details" rendered="#{hierarchiesController.selectedNodeSlot.hostingSlot}">
                                <h3>Installation details</h3>

                                <p:dataTable id="installationTable" value="#{hierarchiesController.installationRecord}" 
                                        var="installationRecord" style="width: 100%;" 
                                        rendered="#{not empty hierarchiesController.installedDevice}">
                                    <p:column headerText="Installed device inventory ID">
                                        <h:link outcome="deviceDetails" value="#{installationRecord.device.serialNumber}" class="link">
                                            <f:param name="id" value="#{installationRecord.device.id}" />
                                        </h:link>                                    
                                    </p:column>
                                    <p:column headerText="Installation date">
                                        <h:outputText value="#{installationRecord.installDate}">
                                            <f:convertDateTime pattern="yyyy-MM-dd" />
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Uninstall" style="text-align: center;">
                                        <p:commandButton title="Uninstall" label="Uninstall" value="Uninstall" 
                                                action="#{hierarchiesController.uninstallDevice(installationRecord.device)}"
                                                update=":hierarchies:installationDetails" ajax="true"
                                                oncomplete="resizeEmptyColumnInHierarchies();" />
                                    </p:column>
                                </p:dataTable>
                                <p:commandButton title="Install device to this slot" type="button" 
                                        value="Install device to this slot" 
                                        rendered="#{empty hierarchiesController.installedDevice}" 
                                        onclick="installDevice.show()" update=":hierarchies:installationDetails" />
                            </p:panel>
                        </h:panelGroup>
                    </p:column>
                </p:row>
                <p:row>
                    <!-- 
                    Added row with 100% width to fill in the space below other tables and to push tables
                    close together
                      -->
                    <p:column id="hierarchiesEmptyColumn">
                    </p:column>
                </p:row>
            </p:panelGrid>
        </h:form>

        <ui:include src="install-device.xhtml">
            <ui:param name="formId" value="installDeviceForm" />
            <ui:param name="dialogTitle" value="Select device instance" />
            <ui:param name="widgetName" value="installDevice" />
            <ui:param name="slot" value="#{hierarchiesController.selectedNodeSlot}" />
            <ui:param name="componentToUpdate"
                value=":hierarchies:attributesTable :hierarchies:relationsTable :hierarchies:installationDetails" />
        </ui:include>

        <script type="text/javascript">
            jQuery(window).resize(function() {
                hierarchiesResizeAll();
            });

            jQuery(document).ready(function() {
                hierarchiesResizeAll();
            });
        </script>
    </ui:define>
</ui:composition>