<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    template="/template/template.xhtml"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html">

    <ui:define name="content">
        <h:form id="hierarchies">
            <script type="text/javascript">
                //<![CDATA[
                function scrollSelectedIntoView() {
                    var hierarchyWidget = PF('hierarchyWidget');
                    if (hierarchyWidget.selections.length > 0) {
                        var scrollableBodyHeight = $('#hierarchies\\:tree .ui-treetable-scrollable-body')[0].clientHeight;
                        var selectedNodeId = "#hierarchies\\:tree_node_" + hierarchyWidget.selections[0];
                        var selectedNode = $(selectedNodeId);
                        var selectedNodePosition = selectedNode[0].offsetTop;
                        var lowerLimit = Math.max(0, selectedNodePosition - scrollableBodyHeight + selectedNode.outerHeight());
                        if (hierarchyWidget.scrollBody.scrollTop() < lowerLimit || hierarchyWidget.scrollBody.scrollTop() > selectedNodePosition) {
                            hierarchyWidget.scrollBody.scrollTop(Math.max(0,selectedNodePosition-scrollableBodyHeight/2));
                        }
                    }
                }
            // ]]>
            </script>
            <p:growl showDetail="true" globalOnly="true" autoUpdate="true" />
            <p:panelGrid id="hierarchiesContainer" style="width: 100%;" styleClass="noBorders">
                <p:row>
                    <p:column rowspan="4" id="treeColumn">
                        <p:fieldset id="treeFieldSet" legend="Slots">
                            <p:treeTable id="tree" value="#{hierarchiesController.rootNode}" var="installationSlot" 
                                    selectionMode="single" selection="#{hierarchiesController.selectedNode}" 
                                    scrollable="true" scrollWidth="auto" rowStyleClass="treeRows" 
                                    style="width: 30em; border-bottom: solid 1px #a8a8a8;" 
                                    widgetVar="hierarchyWidget">
                                <p:ajax event="select" listener="#{hierarchiesController.initSelectedItemLists()}"
                                    update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton 
                                            :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton 
                                            :hierarchies:installationDetails :hierarchies:slotAttributes" 
                                    oncomplete="resizeEmptyColumnInHierarchies();hierarchiesResizeAttributes();" />
                                <p:ajax event="unselect" listener="#{hierarchiesController.clearAttributeList()}"
                                    update=":hierarchies:relationsTable :hierarchies:deleteButton :hierarchies:downButton 
                                            :hierarchies:upButton :hierarchies:editButton :hierarchies:addButton 
                                            :hierarchies:installationDetails :hierarchies:slotAttributes" 
                                    oncomplete="resizeEmptyColumnInHierarchies();" />
                                <p:ajax event="collapse" listener="#{hierarchiesController.onNodeCollapse}" />
                                <p:ajax event="expand" listener="#{hierarchiesController.onNodeExpand}" />
    
                                <p:column id="name" headerText="Name">
                                    <h:outputText value="" rendered="#{installationSlot.isHostingSlot}" 
                                        style="display:inline-block; vertical-align:bottom !important"
                                        styleClass="ui-icon ui-icon-wrench" />
                                    <h:outputText value="" rendered="#{!installationSlot.isHostingSlot}" 
                                        style="display:inline-block; vertical-align:bottom !important"
                                        styleClass="ui-icon ui-icon-folder-collapsed" />
                                    <h:outputText value="#{installationSlot.name}" title="#{installationSlot.description}" />
                                </p:column>
                            </p:treeTable>

                            <p:commandButton id="deleteButton" icon="ui-icon-trash" value="Delete" title="Delete" 
                                style="float: right;  margin-top: 1em;" oncomplete="PF('deleteSlot').show();" 
                                disabled="#{empty hierarchiesController.selectedNode || !hierarchiesController.selectedNode.data.canDelete}" 
                                actionListener="#{hierarchiesController.prepareDeletePopup()}" />
                            <p:commandButton id="downButton" icon="ui-icon-arrowthick-1-s" value="Down" title="Move down" 
                                style="float: right; margin: 1em 1ex 0 0;" oncomplete="hierarchiesResizeAll();scrollSelectedIntoView();"
                                update=":hierarchies:tree :hierarchies:downButton :hierarchies:upButton" 
                                disabled="#{empty hierarchiesController.selectedNode || hierarchiesController.selectedNode.data.last}" 
                                actionListener="#{hierarchiesController.moveSlotDown()}" />
                            <p:commandButton id="upButton" icon="ui-icon-arrowthick-1-n" value="Up" title="Move up" 
                                style="float: right; margin: 1em 1ex 0 0;" oncomplete="hierarchiesResizeAll();scrollSelectedIntoView();"
                                update=":hierarchies:tree :hierarchies:upButton :hierarchies:downButton" 
                                disabled="#{empty hierarchiesController.selectedNode || hierarchiesController.selectedNode.data.first}" 
                                actionListener="#{hierarchiesController.moveSlotUp()}" />
                            <p:commandButton id="editButton" icon="ui-icon-pencil" value="Edit" title="Edit" 
                                style="float: right; margin: 1em 1ex 0 0;" update=":editSlotForm:editSlotDialog" 
                                disabled="#{empty hierarchiesController.selectedNode}" oncomplete="PF('editSlotDialog').show();" 
                                actionListener="#{hierarchiesController.prepareEditPopup()}" />

                            <p:menuButton id="addButton" value="Add" type="button" style="float: right; margin: 1em 1ex 0 0;">
                                <p:menuitem value="Container" oncomplete="PF('addSlotDialog').show();" 
                                        actionListener="#{hierarchiesController.prepareContainerAddPopup}" 
                                        update=":addSlotForm" 
                                        disabled="#{not empty hierarchiesController.selectedNode and hierarchiesController.selectedNodeSlot.hostingSlot}" />
                                <p:menuitem value="Installation slot" oncomplete="PF('addSlotDialog').show();" 
                                        actionListener="#{hierarchiesController.prepareInstallationSlotPopup}" 
                                        update=":addSlotForm" disabled="#{empty hierarchiesController.selectedNode}" />
                            </p:menuButton>
                        </p:fieldset>
                    </p:column>
                    <p:column styleClass="alignTop" >
                        <p:fieldset id="slotAttributes" legend="#{hierarchiesController.selectedNodeSlot.hostingSlot ? hierarchiesController.selectedNodeSlot.componentType.name.concat(' installation slot attributes') : 'Container attributes'}">
                            <p:dataTable id="attributesTable" class="hierarchies-attributes-cell" emptyMessage="No element selected."
                                    value="#{hierarchiesController.attributes}" var="attribute" scrollable="true"
                                    style="width: 100%; overflow-y: hidden; max-height: 324px;" 
                                    filteredValue="#{hierarchiesController.filteredAttributes}">
                                <p:column headerText="Name" sortBy="#{attribute.name}" filterBy="#{attribute.name}" 
                                        filterMatchMode="contains">
                                    <h:outputText value="#{attribute.name}" />
                                </p:column>
    
                                <p:column headerText="Value" style="width: 400px;" sortBy="#{attribute.value}" 
                                        filterBy="#{attribute.value}" filterMatchMode="contains">
                                    <h:outputText value="#{attribute.value}" />
                                </p:column>
    
                                <p:column headerText="Unit" sortBy="#{attribute.unit.name}" filterBy="#{attribute.unit.name}"
                                        filterMatchMode="contains">
                                    <h:outputLink rendered="#{!empty attribute.unit}" 
                                            value="#{request.contextPath}/data-definitions/units/units-manager.xhtml?id=#{attribute.unit.id}">
                                        <h:outputText value="#{attribute.unit.name}" style="text-decoration: underline;" />
                                    </h:outputLink>
                                    <h:outputText value="-" rendered="#{empty attribute.unit}" />
                                </p:column>
    
                                <p:column headerText="Kind" sortBy="#{attribute.kind.toString()}" 
                                        filterBy="#{attribute.kind}" filterMatchMode="exact" 
                                        filterOptions="#{hierarchiesController.attributeKinds}">
                                    <h:outputText value="#{attribute.kind.toString()}" />
                                </p:column>
    
                                <p:column headerText="Data type" sortBy="#{attribute.type.name}" 
                                        filterBy="#{attribute.type.name}" filterMatchMode="contains">
                                    <h:outputText value="#{attribute.type.name}" />
                                </p:column>
                            </p:dataTable>
                        </p:fieldset>

                    </p:column>
                </p:row>
                <p:row>
                    <p:column styleClass="alignTop">
                        <p:fieldset id="relationsTable" legend="Slot relationships">
                            <p:dataTable value="#{hierarchiesController.relationships}" 
                                    style="width: 100%; overflow-y: hidden; max-height: 324px;" var="relationship" 
                                    emptyMessage="No element selected." scrollable="true" class="hierarchies-attributes-cell" 
                                    filteredValue="#{hierarchiesController.filteredRelationships}">
                                <p:column headerText="Relationship" sortBy="#{relationship.relationshipName}" 
                                        filterOptions="#{hierarchiesController.relationshipTypes}" 
                                        filterBy="#{relationship.relationshipName}" filterMatchMode="exact">
                                    <h:outputText value="#{relationship.relationshipName}" />
                                </p:column>
    
                                <p:column headerText="Target" sortBy="#{relationship.targetSlotName}" 
                                        filterBy="#{relationship.targetSlotName}" filterMatchMode="contains">
                                    <p:commandLink action="#{hierarchiesController.selectNode(relationship.slot.id)}" 
                                            update=":hierarchies" oncomplete="hierarchiesResizeAll();scrollSelectedIntoView();">
                                        <h:outputText value="#{relationship.targetSlotName}" 
                                            style="text-decoration: underline;" />
                                    </p:commandLink>
                                </p:column>
                            </p:dataTable>
                        </p:fieldset>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column>
                        <h:panelGroup id="installationDetails" layout="block">
                            <p:fieldset legend="Installation details" rendered="#{not empty hierarchiesController.installationRecord}">
                                <p:dataTable id="installationTable" value="#{hierarchiesController.installationRecord}" 
                                        var="installationRecord" style="width: 100%;">
                                    <p:column headerText="Installed device inventory ID">
                                        <h:link outcome="deviceManager" value="#{installationRecord.device.serialNumber}" class="link">
                                            <f:param name="id" value="#{installationRecord.device.id}" />
                                        </h:link>                                    
                                    </p:column>
                                    <p:column headerText="Installation timestamp">
                                        <h:outputText value="#{installationRecord.installDate}">
                                            <f:convertDateTime pattern="#{msgs.timestampFormat}" />
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Uninstall" style="text-align: center;">
                                        <p:commandButton title="Uninstall" label="Uninstall" value="Uninstall" 
                                                action="#{hierarchiesController.uninstallDevice(installationRecord.device)}"
                                                update=":hierarchies:installationDetails" ajax="true"
                                                oncomplete="resizeEmptyColumnInHierarchies();" />
                                    </p:column>
                                </p:dataTable>
                            </p:fieldset>
                            <p:commandButton title="Install device to this slot" 
                                    value="Install device to this slot" ajax="true" 
                                    actionListener="#{hierarchiesController.prepareUninstalledDevices}" 
                                    rendered="#{empty hierarchiesController.installedDevice and hierarchiesController.selectedNodeSlot.hostingSlot}" 
                                    oncomplete="PF('installDevice').show();" update=":hierarchies:installationDetails" />
                        </h:panelGroup>
                    </p:column>
                </p:row>
                <p:row>
                    <!-- 
                    Added row with 100% width to fill in the space below other tables and to push tables
                    close together
                      -->
                    <p:column id="hierarchiesEmptyColumn">
                    </p:column>
                </p:row>
            </p:panelGrid>
        </h:form>

        <ui:include src="install-device.xhtml">
            <ui:param name="formId" value="installDeviceForm" />
            <ui:param name="dialogTitle" value="Select device instance" />
            <ui:param name="widgetName" value="installDevice" />
            <ui:param name="slot" value="#{hierarchiesController.selectedNodeSlot}" />
            <ui:param name="componentToUpdate"
                value=":hierarchies:slotAttributes :hierarchies:relationsTable :hierarchies:installationDetails" />
        </ui:include>

        <ui:include src="/data-definitions/add-or-modify-dialogs/delete-confirmation.xhtml" >
            <ui:param name="formId" value="deleteSlotForm" />
            <ui:param name="dialogTitle" value="Delete slot" />
            <ui:param name="widgetName" value="deleteSlot" />
            <ui:param name="controller" value="#{hierarchiesController}" />
            <ui:param name="submitHandler" value="onSlotDelete" />
            <ui:param name="formToUpdate" value=":hierarchies:tree :hierarchies:deleteButton :hierarchies:slotAttributes 
                    :hierarchies:relationsTable :hierarchies:installationDetails" />
            <ui:param name="resizeContent" value="hierarchiesResizeAll();" />
            <ui:param name="entityType" value="this slot" />
        </ui:include>

        <ui:include src="add-or-modify-slot.xhtml">
            <ui:param name="formId" value="editSlotForm" />
            <ui:param name="widgetName" value="editSlotDialog" />
            <ui:param name="dialogTitle" value="Edit #{hierarchiesController.selectedNodeSlot.hostingSlot ? 'installation slot' : 'container'}" />
            <ui:param name="submitHandler" value="onSlotModify" />
        </ui:include>

        <ui:include src="add-or-modify-slot.xhtml">
            <ui:param name="formId" value="addSlotForm" />
            <ui:param name="widgetName" value="addSlotDialog" />
            <ui:param name="dialogTitle" value="Add #{hierarchiesController.installationSlot ? 'installation slot' : 'container'}" />
            <ui:param name="submitHandler" value="onSlotAdd" />
        </ui:include>

        <script type="text/javascript">
            jQuery(window).resize(function() {
                hierarchiesResizeAll();
                scrollSelectedIntoView();                
            });

            jQuery(document).ready(function() {
                hierarchiesResizeAll();
                scrollSelectedIntoView();                
            });
        </script>
    </ui:define>
</ui:composition>